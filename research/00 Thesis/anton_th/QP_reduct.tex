 
\chapter{An Additive Reduct of the $P$-adic Numbers}

  Aschenbrenner et. al. computed a linear bound for the vc-density function in the field of $p$-adic numbers,
  but it is not known to be optimal.
  In this paper we investigate a certain $P$-minimal additive reduct of the field of $p$-adic numbers and
  use a cell decomposition result of Leenknegt to compute an optimal bound for that structure.


P-adic numbers are a simple, yet a very deep construction.
They were only discovered a hundred years ago, but could have been studied in classical mathematics when number theory was just forming.
Their construction is simple enough to explain at the undergraduate level, yet has a very rich number theoretic structure.
Normally the real numbers are constructed by first taking rational numbers in decimal form and allowing infinite decimal sequences after the decimal point.

Letting decimals be infinite before the decimal point yields a well behaved mathematical object as well, but with a drastically different behavior from real numbers, now depending on the base in which the decimals were written.

When the base is a prime number p, this constructs p-adic numbers.
These were first studied exclusively within number theory, but later found applications in other areas of math, physics, and computer science.
My research will allow for a finer understanding of the finite structure of polynomially definable sets in p-adic numbers.
Model theory began with G\"odel and Malcev in the 1930s, but first matured as a subject in the work of Abraham Robinson, Tarski, Vaught, and others in the 1950s.
Model theory studies sets definable by first order formulas in a variety of mathematical objects.
Restricting to subsets definable by simple formulas gives access to an array of powerful techniques such as indiscernible sequences and nonstandard extensions.
These allow insights not otherwise accessible by classical methods.
Nonstandard real numbers, for example, formalize the notion of infinitesimals.
Model theory is an extremely flexible field with applications in many areas of mathematics including algebra, analysis, geometry, number theory, and combinatorics as well as some applications to computer science and quantum mechanics.

VC-density was studied in model theory in \cite{density} by Aschenbrenner, Dolich, Haskell, MacPherson, and Starchenko
as a natural notion of dimension for definable families of sets in NIP theories.
In a complete NIP theory $T$ we can define the vc-function

\begin{align*}
  \vc^T = \vc : \N \arr \R \cup \curly{\infty}
\end{align*}

where $\vc(n)$ measures the worst-case complexity of families of definable sets in an $n$-fold Cartesian power of the underlying set of a model of $T$
(see \ref{vc_fn_def} below for a precise definition of $\vc^T$).
The simplest possible behavior is $\vc(n) = n$ for all $n$,
satisfied, for example, if $T$ is o-minimal.
For $T = \Th(\Q_p)$, the paper \cite{density} computes an upper bound for this function to be $2n-1$, and it is not known whether this is optimal.
This same bound holds in any reduct of the field of $p$-adic numbers, but one may expect that the simplified structure of the reduct would allow a better bound.
In \cite{reduct}, Leenknegt provides a cell decomposition result for a certain $P$-minimal additive reduct of the field of $p$-adic numbers.
Using this result, in this paper we improve the bound for the vc-function, showing that in Leenknegt's structure $\vc(n) = n$.

Section 1 defines vc-density and states some basic lemmas about it.
A more in depth exposition of vc-density can be found in \cite{density}.
Section 2 defines and states some basic facts about the theory of $p$-adic numbers.
Here we also introduce the reduct which we will be working with.
Section 3 sets up basic definitions and lemmas that will be needed for the proof.
We define trees and intervals and show how they help with vc-density calculations.
Section 4 concludes the proof.

Throughout the paper, variables and tuples of elements will be simply denoted as $x, y, a, b, \ldots$.
We will occasionally write $\vec a$ instead of $a$ for a tuple in $\Q_p^n$ to emphasize it as an element of the $\Q_p$-vector space $\Q_p^n$.
We denote the arity of a tuple $x$ of variables by $|x|$.
Natural numbers are $\N = \curly{0, 1, \ldots}$.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

\section{$P$-adic numbers}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

The field $\Q_p$ of $p$-adic numbers is often studied in the language of Macintyre 
  \begin{align*}
	\LLM = \curly{0, 1, +, -, \cdot, |, \{P_n\}_{n \in \N}}
  \end{align*}
which is a language $\curly{0, 1, +, -, \cdot}$ of rings together with unary predicates $P_n$ interpreted in $\Q_p$ so as to satisfy

\begin{align*}
  P_n x \leftrightarrow \exists y \; y^n = x
\end{align*}

and a divisibility relation where $a|b$ holds in $\Q_p$ when $\vval a \leq \vval b$.

Note that $P_n\backslash \curly{0}$ is a multiplicative subgroup of $\Q_p$ with finitely many cosets.

\begin{Theorem} [Macintyre '76]
  The $\LLM$-structure $\Q_p$ has quantifier elimination.
\end{Theorem}

There is also a cell decomposition result:
\begin{Definition}
  Define \defn{$k$-cells} recursively as follows.
  A \defn{$0$-cell} is a singleton subset of $\Q_p$.
  A \defn{$(k+1)$-cell} is a subset of $\Q_p^{k+1}$ of the following form:
  \begin{align*}
    \curly{(x, t) \in D \times \Q_p \mid \vval a_1(x) \ \square_1 \vval (t - c(x)) \ \square_2 \vval a_2(x), t - c(x) \in \lambda P_n}
  \end{align*}
  where $D$ is a $k$-cell,
  $a_1(x), a_2(x), c(x)$ are definable functions $D \arr \Q_p$,
  each of $\square_i$ is $<, \leq$ or no condition,
  $n \in \N$,
  and
  $\lambda \in \Q_p$.    
\end{Definition}

\begin{Theorem} [Denef '84]
  Any definable subset of $\Q_p^n$ defined by an $\LLM$-formula decomposes into a finite disjoint union of $n$-cells.
\end{Theorem}  

In \cite{density}, Aschenbrenner, Dolich, Haskell, Macpherson, and Starchenko show that $\Q_p$ as $\LLM$-structure satisfies $\vc(n) \leq 2n - 1$,
however it is not known whether this bound is optimal.

In \cite{reduct}, Leenknegt analyzes the reduct of $\Q_p$ to the language
\begin{align*}
  \LL_{aff}  = \curly{0, 1, +, -, \curly{\bar c}_{c \in \Q_p}, |, \curly{Q_{m,n}}_{m,n\in \N}}
\end{align*}
where $\bar c$ denotes a scalar multiplication by $c$,
$a | b$ as above stands for $\vval a \leq \vval b$,
and $Q_{m,n}$ is a unary predicate interpreted as
\begin{align*}
  Q_{m,n} = \bigcup_{k \in \Z} p^{km} (1 + p^n\Z_p).
\end{align*}
Note that $Q_{m,n} \backslash \curly{0}$ is a subgroup of the multiplicative group of $\Q_p$ with finitely many cosets.
One can check that these extra relation symbols are definable in the $\LLM$-structure $\Q_p$.
The paper \cite{reduct} provides a cell decomposition result with the following cells:

\begin{Definition} \label{cell}
  A \defn{$0$-cell} is a singleton subset of $\Q_p$.
  A \defn{$(k+1)$-cell} is a subset of $\Q_p^{k+1}$ of the following form:
  \begin{align*}
    \curly{(x, t) \in D \times \Q_p \mid \vval a_1(x) \ \square_1 \vval (t - c(x)) \ \square_2 \vval a_2(x), t - c(x) \in \lambda Q_{m,n} }
  \end{align*}
  where $D$ is a $k$-cell, called the \defn{base} of the cell,
  $a_1(x), a_2(x), c(x)$ are polynomials of degree $\leq 1$, called the \defn{defining polynomials}
  each of $\square_1, \square_2$ is $<$ or no condition,
  $m,n \in \N$,
  and
  $\lambda  \in\Q_p$.
  We call $\Q_{m,n}$ the \defn{defining predicate}.
\end{Definition}

\begin{Theorem}[Leenknegt '12] 
  Any definable subset of $\Q_p^n$ defined by an $\LL_{aff}$-formula decomposes into a finite disjoint union of $n$-cells.
  %Any formula $\phi(x, t)$ in $(\Q_p, \LL_{aff})$ with $|x| = n$ and $|t| = 1$ decomposes into a union of $(k+1)$-cells.
\end{Theorem}  

Moreover, \cite{reduct} shows that $\LLA$-structure $\Q_p$ is a $P$-minimal reduct,
that is, the one-dimensional definable sets of $\LLA$-structure $\Q_p$
coincide with the one-dimensional definable sets in the full structure $\LLM$-structure $\Q_p$.

The main result of this paper is the computation of the $\vc$-function for this structure:
\begin{Theorem} \label{main_theorem}
  $\LLA$-structure $\Q_p$ has $\vc(n) = n$.
\end{Theorem}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

\section{Key Lemmas and Definitions}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 



To show that $\vc(n) = n$ it suffices to bound $\vc^*(\phi) \leq |x|$ for every $\LL_{aff}$-formula $\phi(x; y)$.
Fix such a formula $\phi(x; y)$.
Instead of working with it directly, we first simplify it using quantifier elimination.
The required quantifier elimination result can be easily obtained from cell decomposition:
\begin{Lemma} \label {quantifier_elimination}
  Any formula $\phi(x; y)$ in $\LLA$-structure $\Q_p$. can be written as a boolean combination of formulas from a collection
  \begin{align*}
    \Phi(x; y) = &\curly{\vval (p_i(x) - c_i(y)) < \vval (p_j(x) - c_j(y))}_{i, j \in I} \cup \\
                 &\curly{p_i(x) - c_i(y) \in \lambda_k Q_{m,n}}_{i \in I , k \in K}
  \end{align*}
  of $\LLA$-formulas
  where $I, K$ are finite index sets,
  each $p_i$ is a degree $\leq 1$ polynomial in $x$ without a constant term,
  each $c_i$ is a degree $\leq 1$ polynomial in $y$,
  $m,n \in \N$,
  and
  $\lambda_k \in \Q_p$.
\end{Lemma}

\begin{proof}
  Let $l = |x| + |y|$.
  Partition the subset of $\Q_p^l$ defined by $\phi$ to obtain $\DD^l$, a collection of $l$-cells.
  Let $\DD^{l-1}$ be the collection of the bases of the cells in $\DD^l$.
  Similarly, construct by induction $\DD^i$ for each $0 \leq j < l$,
  where $\DD^j$ is the collection of $j$-cells which are the bases of cells in $\DD^{j+1}$.
  Set
  \begin{align*}
    &m = \prod \curly{m' \mid Q_{m',n'} \text{ is the defining predicate of a cell in $\DD^j$ for $0 \leq j \leq l$} } \\
    &n = \max \curly{n' \mid Q_{m',n'} \text{ is the defining predicate of a cell in $\DD^j$ for $0 \leq j \leq l$} }
  \end{align*}
  % Choose $m,n$ large enough to cover all $m', n'$ for $Q_{m',n'}$ that show up in the cells of $\DD$.
  This way if $a, a'$ are in the same coset of $Q_{m',n'}$ then they are in the same coset of $Q_{m,n}$.
  Choose $\curly{\lambda_k}_{k \in K}$ to range over all the cosets of $Q_{m,n}$.
  Let $q_i(x, y)$ enumerate all of the defining polynomials $a_1(x), a_2(x), t - c(x)$ that show up in the cells of $\DD^j$ for any $j$.
  All if those are all polynomials of degree $\leq 1$ in variables $x, y$.
  We can split each of them as $q_i(x,y) = p_i(x) - c_i(y)$ where the constant term of $q_i$ goes into $c_i$.
  This gives us the appropriate finite collection of formulas $\Phi$.
  From the cell decomposition it is easy to see that when $a, a'$ have the same $\Phi$-type,
  then they have the same $\phi$-type.
  Thus $\phi$ can be written as a boolean combination of formulas from $\Phi$.
\end{proof}

\begin{Lemma}
  Let $\Phi(x; y)$ be a finite collection of formulas.
  If $\phi$ can be written as a boolean combination of formulas from $\Phi$ then
  \begin{align*}
    \vc^* (\Phi) \leq r \implies \vc^* (\phi) \leq r \; \text{ for all } r \in \R.
  \end{align*}
\end{Lemma}
\begin{proof}
  If $a,a'$ have the same $\Phi$-type over $B$, then they have the same $\phi$-type over $B$, where $B$ is some parameter set.
  Therefore the number of $\phi$-types is bounded by the number of $\Phi$-types.
  The bound follows from Lemma \ref{count_types}.
\end{proof}

For the remainder of the paper fix $\Phi(x; y)$ to be the collection of formulas defined by Lemma \ref{quantifier_elimination}.
By the previous lemma, to show that $\vc^*(\phi) \leq |x|$, it suffices to bound $\vc^*(\Phi) \leq |x|$.
More precisely, it is sufficient to show that if there is a parameter set $B$ of size $N$
then the number of $\Phi$-types over $B$ is $O(N^{|x|})$.
Fix such a parameter set $B$ and work with it from now on.
We will compute a bound for the number of $\Phi$-types over $B$.

Consider the set $T = T(\Phi, B) = \curly{c_i(b) \mid b \in B, i \in I} \subset \Q_p$.
In this definition $B$ is the parameter set that we have fixed 
and $c_i(b)$ come from the collection of formulas $\Phi$ from the quantifier elimination above.
View $T$ as a tree as follows:
\begin{Definition} \ 
  \begin{itemize}
  \item For $c \in \Q_p, \alpha \in \Z$  define a \defn{ball} 
    \begin{align*}
      B(c, \alpha) = \curly{c' \in \Q_p \mid \vval \paren{c' - c} > \alpha}.  
    \end{align*}
    We also let $B(c, -\infty) = \Q_p$ and $B(c, +\infty) = \emptyset$.
  \item Define a collection of balls $\BB = \curly{B(t_1, \vval(t_1 - t_2))}_{t_1, t_2 \in T}$.
    Note that $\BB$ is a (directed) boolean algebra of sets in $\Q_p$.
    We refer to the atoms in that algebra as \defn{intervals}.
    Note that the intervals partition $\Q_p$ so any element $a \in \Q_p$ belongs to a unique interval.
  \item Let's introduce some notation for the intervals.
    For $t \in T$ and $\alpha_L, \alpha_U \in \Z \cup \curly{-\infty, +\infty}$ define
    \begin{align*}
      \interval = B(t, \alpha_L) \backslash \bigcup \curly{B(t', \alpha_U) \mid t' \in T, \vval(t' - t) \geq \alpha_U}
    \end{align*}
    (this is sometimes referred to as the swiss cheese construction).
    One can check that every interval is of the form $\interval$ for some values of $t, \alpha_L, \alpha_U$.
    The quantities $\alpha_L, \alpha_U$ are uniquely determined by the interval $\interval$,
    while $t$ might not be.
  \item Intervals are a natural construction for trees, however we will require a more refined notion to make Lemma \ref{main_lemma} below work.
    Define a larger collection of balls 
    \begin{align*}
      \BB' = \BB \cup \curly{B(c_i(b), \vval(c_j(b) - c_k(b)))}_{i,j,k \in I, b \in B}.  
    \end{align*}
    Similar to the previous definition, we define a \defn{subinterval} to be an atom of the boolean algebra generated by $\BB'$.
    Subintervals refine intervals.
    Moreover, as before, each subinterval can be written as $\interval$ for some values of $t, \alpha_L, \alpha_U$.
    As before, $\alpha_L, \alpha_U$ are uniquely determined by the subinterval $\interval$,
    while $t$ might not be.
  \end{itemize}
\end{Definition}

\input{whole_figure}  

Subintervals are fine enough to make Lemma \ref{main_lemma} below work while coarse enough to be $O(N)$ small:
\begin{Lemma} \label{interval_count}\ 
  \begin{itemize}
  \item 
    There are at most $2|T| = 2 N |I| = O(N)$ different intervals.
  \item 
    There are at most $2|T| + |B| \cdot |I|^3 = O(N)$ different subintervals.
  \end{itemize}
\end{Lemma}

\begin{proof}
  Each new element in the tree $T$ adds at most two intervals to the total count,
  so by induction there can be at most $2|T|$ many intervals.
  Each new ball in $\BB' \backslash \BB$ adds at most one subinterval to the total count,
  so by induction there are at most $|\BB' \backslash \BB|$ more subintervals than there are intervals.
\end{proof}


\begin{Definition}
  Suppose $a \in \Q_p$ lies in the interval $\interval$. 
  Define the \defn{T-valuation} of $a$ to be $\tval(a) = \vval(a - t)$.    
\end{Definition}

This is a natural notion having the following properties:
\begin{Lemma}  \label{tval} \ 
  \begin{enumerate}[label=(\alph*)]
  \item $\tval(a)$ is well-defined, independent of choice of $t$ to represent the interval.
  \item If $a \in \Q_p$ lies in the subinterval $\interval$,
    then $\tval(a) = \vval(a - t)$.
  \item If $a \in \Q_p$ lies in the (sub)interval $\interval$ 
    then $\alpha_L < \tval(a) \leq \alpha_U$.
  \item For any $a \in \Q_p$ lying in the (sub)interval $\interval$ and $t' \in T$:
    \begin{itemize}
    \item If $\vval(t - t') \geq \alpha_U$, then $\vval(a - t') = \tval(a)$. 
    \item If $\vval(t - t') \leq \alpha_L$, then $\vval(a - t') = \vval(t - t') \paren{\leq \alpha_L < \tval(a)}$. 
    \end{itemize}
  \end{enumerate}
\end{Lemma}


\begin{proof}
  (a)-(c) are clear.
  For (d) fix $t' \in T$ and suppose $a \in \Q_p$ lies in the subinterval $\inti(t, \alpha_L', \alpha_U')$.
  This  subinterval lies inside of a unique interval $\interval$ for some choice of $\alpha_L, \alpha_U$ and
  by the definition of intervals (or more specifically $\BB$):
  \begin{align*}
    \vval(t - t') \geq \alpha_U &\iff \vval(t - t') \geq \alpha_U',\\
    \vval(t - t') \geq \alpha_L &\iff \vval(t - t') \geq \alpha_L'.
  \end{align*}
  Therefore without loss of generality we may assume that $a \in \Q_p$ lies in an interval $\interval$.
  By (c) and the definition of intervals one of the three following cases has to hold.
  
  Case 1: $\vval(t - t') \geq \alpha_U$ and $\tval(a) < \alpha_U$. Then
  \begin{align*}
    \vval(t - t') \geq \alpha_U > \tval(a) = \vval(a - t),
  \end{align*}
  thus $\vval(a - t') = \vval(a - t) = \tval(a)$ as needed.

  Case 2: $\vval(t - t') \geq \alpha_U$ and $\tval(a) = \alpha_U$. Then
  \begin{align*}
    \tval(a) = \vval(a - t) = \vval(t - t') \geq \alpha_U,
  \end{align*}
  thus $\vval(a - t') \geq \alpha_U$.
  The interval $\interval$ is disjoint from the ball $B(t', \alpha_U)$,
  so $a \notin B(t', \alpha_U)$, that is, $\val(a - t') \leq \alpha_U$.
  Combining this with the previous inequality we get that $\val(a - t') = \alpha_U = \tval(a)$ as needed.

  Case 3: $\vval(t - t') \leq \alpha_L$. Then
  \begin{align*}
    \vval(t - t') \leq \alpha_L < \tval(a) = \vval(a - t),
  \end{align*}
  thus $\vval(a - t') = \vval(t - t')$ as needed. 
\end{proof}




\begin{Definition}
  Suppose $a \in \Q_p$ lies in the subinterval $\interval$.
  We say that $a$ is \defn{far from the boundary} tacitly (of $\interval$) if 
    \begin{align*}
	\alpha_L + n \leq \tval(a) \leq \alpha_U - n.
    \end{align*}
  Here $n$ is as in Lemma \ref{quantifier_elimination}.
  Otherwise we say that it is \defn{close to the boundary} (of $\interval$).
\end{Definition}

\begin{Definition}
  Suppose $a_1, a_2 \in \Q_p$ lie in the same subinterval $\interval$.
  We say $a_1, a_2$ have the same \defn{subinterval type} if one of the following holds:
  \begin{itemize}
  \item Both $a_1, a_2$ are far from the boundary and $a_1 - t, a_2 - t$ are in the same $Q_{m,n}$-coset.
    (Here $Q_{m,n}$ is an in Lemma \ref{quantifier_elimination}.)
  \item Both $a_1, a_2$ are close to the boundary and 
    \begin{align*}
	  \tval(a_1) = \tval(a_2) \leq \vval(a_1 - a_2) - n.
    \end{align*}
  \end{itemize}      
\end{Definition}


\begin{Definition}
	For $c \in \Q_p$ and $\alpha, \beta \in \Z, \alpha < \beta$ define $c \midr [\alpha, \beta)$
  to be the record of the coefficients of $c$ for the valuations between $[\alpha, \beta)$.
  More precisely write $c$ in its power series form
  \begin{align*}
    c = \sum_{\gamma \in \Z} c_\gamma p^\gamma \text{ with } c_\gamma \in \curly{0,1, \ldots, p-1}
  \end{align*}
  Then $c \midr [\alpha, \beta)$ is just $(c_\alpha, c_{\alpha+1}, \ldots c_{\beta - 1}) \in \curly{0,1, \ldots, p-1}^{\beta - \alpha}$.
\end{Definition}

The following lemma is an adaptation of Lemma 7.4 in \cite{density}.
\begin{Lemma} \label{distance}
  Fix $m,n \in \N$.
  For any $x,y,c \in \Q_p$, if
  \begin{align*}
    \val (x - c) = \val (y - c) \leq \val (x - y) - n,
  \end{align*}
  then $x - c, y - c$ are in the same coset of $Q_{m,n}$.
\end{Lemma}
\begin{proof}
  Call $a,b \in \Q_p$ similar if $\val a = \val b$ and
  \begin{align*}
    a \midr [\val a, \val a + n) = b \midr [\val b, \val b + n).
  \end{align*}
  If $a,b$ are similar then
  \begin{align*}
    a \in Q_{m,n} \iff b \in Q_{m,n}.
  \end{align*}
  Moreover for any $\lambda \in \Q_p^\times$, if $a,b$ are similar then so are $\lambda a, \lambda b$.
  Thus if $a,b$ are similar, then they belong to the same coset of $Q_{m,n}$.
  The hypothesis of the lemma force $x - c, y - c$ to be similar, thus belonging to the same coset.
\end{proof} 


\begin{Lemma} \label{interval_type_count}
  For each subinterval there are at most $K = K(Q_{m,n})$ many subinterval types 
  (with $K$ not depending on $B$ or on the subinterval).  
\end{Lemma}

\begin{proof}
  Let $a, a' \in \Q_p$ lie in the same subinterval $\interval$.

  Suppose $a, a'$ are far from the boundary.
  Then they have the same subinterval type if $a - t, a' - t$ are in the same $Q_{m,n}$-coset.
  So the number of such subinterval types is bounded by the number of $Q_{m,n}$-cosets.

  Suppose $a, a'$ are close to the boundary and
  \begin{align*}
    &\tval(a) - \alpha_L = \tval(a') - \alpha_L < n \text { and}\\
    &a \midr [\tval(a), \tval(a) + n) = a' \midr [\tval(a'), \tval(a') + n).
  \end{align*}
  Then $a, a'$ have the same subinterval type.
  Such a subinterval type is thus determined by $\tval(a) - \alpha_L$ and the tuple $a \midr [\tval(a), \tval(a) + n)$,
  therefore there are at most $n p^n$ many such types.

  A similar argument works for $a$ with $\alpha_U - \tval(a) \leq n$.

  Adding all this up we get that there are at most
  \begin{align*}
    K = \text{(number of $Q_{m,n}$ cosets)} + 2 n p^n  
  \end{align*}
  many subinterval types.
\end{proof}

The following critical lemma relates tree notions to $\Phi$-types.
\begin{Lemma} \label{main_lemma}
  Suppose $d, d' \in \Q_p^{|x|}$ satisfy the follwing three conditions:
  \begin{itemize}
  \item For all $i \in I$ $p_i(d)$ and $p_i(d')$ are in the same subinterval.
  \item For all $i \in I$ $p_i(d)$ and $p_i(d')$ have the same subinterval type.
  \item For all $i,j \in I$, $\tval(p_i(d)) > \tval(p_j(d))$ iff $\tval(p_i(d')) > \tval(p_j(d'))$.
  \end{itemize}
  Then $d, d'$ have the same $\Phi$-type over $B$.
\end{Lemma}
\begin{proof}
  There are two kinds of formulas in $\Phi$
  (see Lemma \ref{quantifier_elimination}).
  First we show that $d, d'$ agree on formulas of the form $p_i(x) - c_i(y) \in \lambda_k Q_{m,n}$.
  It is enough to show that for every $i \in I, b \in B$, $p_i(d) - c_i(b), p_i(d') - c_i(b)$ are in the same $Q_{m,n}$-coset.
  Fix such $i, b$.
  For brevity let $a = p_i(d), a' = p_i(d')$ and $Q = Q_{m,n}$.
  We want to show that $a - c_i(b), a' - c_i(b)$ are in the same $Q$-coset.
  
  Suppose $a, a'$ are close to the boundary.
  Then $\tval(a) = \tval(a') \leq \val(a - a') - n$.
  Using Lemma \ref{tval}d, we have
  \begin{align*}
    \val(a - c_i(b)) = \val(a' - c_i(b)) \leq \tval(a) \leq \val(a - a') - n.
  \end{align*}
  Lemma \ref{distance} shows that $a - c_i(b), a' - c_i(b)$ are in the same $Q$-coset.
  
  Now, suppose both $a, a'$ are far from the boundary.
  Let $\interval$ be the interval containing $a, a'$.
  Then we have 
  \begin{align*}
    \alpha_L + n \leq &\val (a - t) \leq \alpha_U - n, \\
    \alpha_L + n \leq &\val (a' - t) \leq \alpha_U - n
  \end{align*}
  (as being far from the subinterval's boundary also makes $a,a'$ far from interval's boundary).
  We have either $\val(t - c_i(b)) \geq \alpha_U$ or $\val(t - c_i(b)) \leq \alpha_L$ (as otherwise it would contradict the definition of intervals, or more specifically $\BB$).
  
  Suppose it is the first case $\val(t - c_i(b)) \geq \alpha_U$.
  Then using Lemma \ref{tval}d
  \begin{align*}
    \val(a - c_i(b)) = \val(a - t) \leq \alpha_U - n \leq \val(t - c_i(b)) - n.
  \end{align*}
  So by Lemma \ref{distance} $a - c_i(b), a - t$ are in the same $Q$-coset.
  By an analogous argument, $a' - c_i(b), a' - t$ are in the same $Q$-coset.
  As $a, a'$ have the same subinterval type, $a - t, a' - t$ are in the same $Q$-coset.
  Thus by transitivity we get that $a - c_i(b), a' - c_i(b)$ are in the same $Q$-coset.
  
  For the second case, suppose $\val(t - c_i(b)) \leq \alpha_L$.
  Then using Lemma \ref{tval}d
  \begin{align*}
    \val(a - c_i(b)) = \val(t - c_i(b)) \leq \alpha_L \leq \val(a - t) - n,
  \end{align*}
  so by Lemma \ref{distance}, $a - c_i(b), t - c_i(b)$ are in the same $Q$-coset.
  Similarly $a' - c_i(b), t - c_i(b)$ are in the same $Q$-coset.
  Thus by transitivity we get that $a - c_i(b), a' - c_i(b)$ are in the same $Q$-coset.

  Next, we need to show that $d, d'$ agree on formulas of the form
  $\vval (p_i(x) - c_i(y)) < \vval (p_j(x) - c_j(y))$ 
  (again, referring to the presentation in Lemma \ref{quantifier_elimination}).
  Fix $i,j \in I, b \in B$.
  We would like to show the following equivalence: 

  \begin{multline} \label {eq:order_equation}
    \vval (p_i(d) - c_i(b)) < \vval (p_j(d) - c_j(b)) \iff \\
    \iff \vval (p_i(d') - c_i(b)) < \vval (p_j(d') - c_j(b))
  \end{multline}

  Suppose $p_i(d), p_i(d')$ are in the subinterval $\inti(t_i, \alpha_i, \beta_i)$ and 
  $p_j(d), p_j(d')$ are in the subinterval $\inti(t_j, \alpha_j, \beta_j)$.
  Lemma \ref{tval}d yields the following four cases.

  Case 1:
  \begin{align*}
    &\vval (p_i(d) - c_i(b)) = \vval (p_i(d') - c_i(b)) = \vval(t_i - c_i(b)) \\
    &\vval (p_j(d) - c_j(b)) = \vval (p_j(d') - c_j(b)) = \vval(t_j - c_j(b))
  \end{align*}
  Then it is clear that the equivalence \eqref{eq:order_equation} holds.

  Case 2:
  \begin{align*}
    &\vval (p_i(d) - c_i(b)) = \tval(p_i(d)) \text{ and } \vval (p_i(d') - c_i(b)) = \tval(p_i(d')) \\
    &\vval (p_j(d) - c_j(b)) = \tval(p_j(d)) \text{ and } \vval (p_j(d') - c_j(b)) = \tval(p_j(d'))
  \end{align*}
  Then the equivalence \eqref{eq:order_equation} holds by the third hypothesis of the lemma (that order of T-valuations is preserved).

 Case 3:
  \begin{align*}
    &\vval (p_i(d) - c_i(b)) = \vval (p_i(d') - c_i(b)) = \vval(t_i - c_i(b)) \\
    &\vval (p_j(d) - c_j(b)) = \tval(p_j(d)) \text{ and } \vval (p_j(d') - c_j(b)) = \tval(p_j(d'))
  \end{align*}
  If $p_j(d), p_j(d')$ are close to the boundary,
  then $\tval(p_j(d)) = \tval(p_j(d'))$ and the equivalence \eqref{eq:order_equation} clearly holds.
  Suppose then that $p_j(d), p_j(d')$ are far from the boundary.
  \begin{align*}
    \alpha_j + n \leq &\tval(p_j(d)), \tval(p_j(d')) \leq \beta_j - n \\
    \alpha_j < &\tval(p_j(d)), \tval(p_j(d')) < \beta_j
  \end{align*}
  and $\vval(t_i - c_i(b))$ lies outside of the $(\alpha_j, \beta_j)$
  by the definition of subinterval (more specifically definition of $\BB'$).
  Therefore \eqref{eq:order_equation} has to hold.
  (Note that we always have $\tval(p_j(d)), \tval(p_j(d')) \in (\alpha_j, \beta_j]$ by Lemma \ref{tval}c, so 
  we only need the condition on being far from the boundary to avoid the edge case of equality to $\beta_j$.)

  Case 4:
  \begin{align*}
    &\vval (p_i(d) - c_i(b)) = \tval(p_i(d)) \text{ and } \vval (p_i(d') - c_i(b)) = \tval(p_i(d')) \\
    &\vval (p_j(d) - c_j(b)) = \vval (p_j(d') - c_j(b)) = \vval(t_j - c_j(b))
  \end{align*}
  Similar to case 3 (switching $i,j$).
\end{proof}



  The previous lemma gives us an upper bound on the number of types - there are at most $|2I|!$ many choices for the order of $\tval$,
  $O(N)$ many choices for the subinterval for each $p_i$,
  and $K$ many choices for the subinterval type for each $p_i$ (where $K$ is as in Lemma \ref{interval_type_count}),
  giving a total of $O(N^{|I|}) \cdot K^{|I|} \cdot |I|! = O(N^{|I|})$ many types.
  This implies $\vc^*(\Phi) \leq |I|$.
  The biggest contribution to this bound are the choices among the $O(N)$ many subintervals for each $p_i$ with $i \in I$.
  Are all of those choices realized?
  Intuitively there are $|x|$ many variables and $|I|$ many equations,
  so once we choose a subinterval for $|x|$ many $p_i$'s, the subintervals for the rest should be determined.
  This would give the required bound $\vc^*(\Phi) \leq |x|$.
  The next section outlines this idea formally.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

\section{Main Proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

An alternative way to write $p_i(c)$ is as a scalar product $\vec p_i \cdot \vec c$,
where $\vec p_i$ and $\vec c$ are vectors in $\Q_p^{|x|}$ (as $p_i(x)$ is homogeneous linear).

\begin{Lemma}	 
  Suppose we have a finite collection of vectors $\curly{\vec p_j}_{j \in J}$ with each $\vec p_j \in \Q_p^{|x|}$.
  Suppose $\vec p \in \Q_p^{|x|}$ satisfies $\vec p \in \vecspan \curly{\vec p_j}_{j \in J}$,
  and we have $\vec c \in \Q_p^{|x|}, \alpha \in \Z$ with $\val(\vec p_j \cdot \vec c) > \alpha \text{ for all } j \in J$.
  Then $\val(\vec p \cdot \vec c) > \alpha - \gamma$ for some $\gamma \in \N$.
  Moreover $\gamma$ can be chosen independently from $\vec c, \alpha$ depending only on $\curly{\vec p_j}_{j \in J}$.
\end{Lemma}

\begin{proof}
  For some $c_j \in \Q_p$ for $j \in J$ we have $\vec p = \sum_{j \in J} c_j \vec p_j$,
  hence $\vec p \cdot \vec c = \sum_{j \in J} c_j \vec p_j \cdot \vec c$.
  Thus
  \begin{align*}
    \val \paren{c_j \vec p_j \cdot \vec c} = \val \paren{c_j} + \val \paren{\vec p_j \cdot \vec c} > \val \paren{c_j} + \alpha.
  \end{align*}
  % Pick $\gamma = -\max \val \paren{c_i}$ or $0$ if all those values are positive.
  Let $\gamma = \max(0, -\max_{j \in J} \val \paren{c_j})$.
  % Let $\gamma = -\min(0, \max_{j \in J} \val \paren{c_j})$.
  % Let $\gamma = \max(0, \min -\val \paren{c_j})$.
  Then we have 
  \begin{align*}
    &\val(\vec p \cdot \vec c) =
      \val \paren{\sum_{j \in J} c_j \vec p_j \cdot \vec c} \geq \\
      \geq &\min_{j \in J} \val(\sum_{j \in J} c_j \vec p_j \cdot \vec c) >
      \min_{j \in J} \val(c_j) + \alpha \geq
      \alpha - \gamma
  \end{align*}
  as required.
\end{proof}

\begin{Corollary}	 \label{gamma}
  Suppose we have a finite collection of vectors $\curly{\vec p_i}_{i \in I}$ with each $\vec p_i \in \Q_p^{|x|}$.
  Suppose $J \subseteq I$ and $i \in I$ satisfy $\vec p_i \in \vecspan \curly{\vec p_j}_{j \in J}$,
  and we have $\vec c \in \Q_p^{|x|}, \alpha \in \Z$ with $\val(\vec p_j \cdot \vec c) > \alpha \text{ for all } j \in J$.
  Then $\val(\vec p_i \cdot \vec c) > \alpha - \gamma$
  for some $\gamma \in \N$.
  Moreover $\gamma$ can be chosen independently from $J, j, \vec c, \alpha$ depending only on $\curly{\vec p_i}_{i \in I}$.
\end{Corollary}
\begin{proof}
  The previous lemma shows that we can pick such $\gamma$ for a given choice of $i, J$, but independent from $\alpha, \vec c$.
  To get a choice independent from $i, J$, go over all such eligible choices 
  ($i$ ranges over $I$ and $J$ ranges over subsets of $I$),
  pick $\gamma$ for each, and then take the maximum of those values.  
\end{proof}

Fix $\gamma$ according to Corollary \ref{gamma} corresponding to $\curly{\vec p_i}_{i \in I}$ given by our collection of formulas $\Phi$.
(The lemma above is a general result, but we only use it applied to the vectors given by $\Phi$.)

\begin{Definition}
  Suppose $a \in \Q_p$ lies in the subinterval $\interval$.
  Define the \defn{$T$-floor} of $a$ to be $\tfl(a) = \alpha_L$.
\end{Definition}

\begin{Definition}
  Let $f: \Q_p^{|x|} \arr \Q_p^I$ with $f(c) = (p_i(c))_{i \in I}$.
  Define the segment space $\Sg$ to be the image of $f$.
  Equvalently:
  \begin{align*}
    \Sg = \curly{(p_i(c))_{i \in I} \mid c \in \Q_p^{|x|}} \subseteq \Q_p^I
  \end{align*}
\end{Definition}

Without loss of generality, we may assume that $I = \curly{1,2, \ldots, k}$ (that is the formulas are labeled by consecutive natural numbers).
Given a tuple $(a_i)_{i\in I}$ in the segment space,
look at the corresponding $T$-floors $\curly{\tfl(a_i)}_{i\in I}$ and T-valuations $\curly{\tval(a_i)}_{i\in I}$.
Partition the segment space by the order types of $\{\tfl(a_i)\}_{i\in I}$ and $\curly{\tval(a_i)}_{i\in I}$ (as subsets of $\Z$).

Work in a fixed set $\Sg'$ of the partition.
After relabeling the $p_i$ we may assume that
\begin{align*}
  \tfl(a_1) \geq \tfl(a_2) \geq \ldots \text { for all $a_i \in \Sg'$}
\end{align*}

Consider the (relabeled) sequence of vectors $\vec p_1, \vec p_2, \ldots, \vec p_I$.
There is a unique subset $J \subset I$ such that the set of all vectors with indices in $J$ is linearly independent,
and all vectors with indices outside of $J$ are a linear combination of preceding vectors.
(We can pick those using a greedy algorithm for finding a linearly independent subset of vectors.)
We call indices in $I$ \defn{independent} and we call the indices in $I \setminus J$ \defn{dependent}.


\begin{Definition} \ 
  \begin{itemize}
  \item Denote $\curly{0,1, \ldots, p-1}$ as \defn{$\Ct$}.
    %Note that $|\Ct| = p^\gamma$.
  \item Let \defn{$\It$} be the space of all subinterval types.
    By Lemma \ref{interval_type_count} we have $|\It| \leq K$.
  \item Let \defn{$\Sub$} be the space of all subintervals.
    By Lemma \ref{interval_count} we have $|\Sub| \leq 3 |I|^2 \cdot N = O(N)$.
  \end{itemize}
\end{Definition}

\begin{Definition}
  Now, we define a function
  \begin{align*}
    g_{\Sg'}: \Sg' \arr \It^I \times \Sub^J \times \Ct^{I \backslash J}
  \end{align*}
  as follows:
  
  Let $a = (a_i)_{i\in I} \in \Sg'$.
  To define $g_{\Sg'}(a)$ we need to specify where it maps $a$ in each individual component of the product.

  For each $a_i$ record its subinterval type, giving the first component in $\It^I$.

  For $a_j$ with $j \in J$, record the subinterval of $a_j$, giving the second component in $\Sub^J$.

  For the third component (an element of $\Ct^{I \backslash J}$) do the following computation.
  Pick $a_i$ with $i$ dependent.
  Let $j$ be the largest independent index with $j < i$.
  Record $a_i \midr [\tfl(a_j) - \gamma, \tfl(a_j))$.

  Combine $g_{\Sg'}$ for all the partitions to get a function 
  \begin{align*}
    g: \Sg \arr \It^I \times \Sub^J \times \Ct^{I \backslash J}.  
  \end{align*}
\end{Definition}

\begin{Lemma}
  Suppose we have $c, c' \in \Q_p^{|x|}$ such that $f(c), f(c')$ are in the same
  set $\Sg'$ of the partition of $\Sg$ and $g(f(c)) = g(f(c'))$.
  Then $c, c'$ have the same $\Phi$-type over $B$.
\end{Lemma}

\newcommand{\pvec}[1]{\vec{#1}\mkern2mu\vphantom{#1}}

\begin{proof}
  Let $a_i = \vec p_i \cdot \vec c$ and $a_i' = \vec p_i \cdot \pvec c'$ so that

  \begin{align*}
    f(c) &= (p_i(c))_{i \in I} = (\vec p_i \cdot \vec c)_{i \in I} = (a_i)_{i \in I} \\
    f(c') &= (p_i(c'))_{i \in I} = (\vec p_i \cdot \pvec c')_{i \in I} = (a_i')_{i \in I}
  \end{align*}

  For each $i$ we show that $a_i, a_i'$ are in the same subinterval and have the same subinterval type, so the conclusion follows by Lemma \ref{main_lemma}
  ($f(c), f(c')$ are in the same partition ensuring the proper order of T-valuations for the 3rd condition of the lemma).
  $\It$ records the subinterval type of each element, so if $g(\bar a) = g(\bar a')$ then $a_i, a_i'$ have the same subinterval type for all $i \in I$.
  Thus it remains to show that $a_i, a_i'$ lie in the same subinterval for all $i \in I$.
  Suppose $i$ is an independent index.
  Then by construction, $\Sub$ records the subinterval for $a_i, a_i'$, so those have to belong to the same subinterval.
  Now suppose $i$ is dependent.
  Pick the largest $j < i$ such that $j$ is independent.
  We have $\tfl(a_i) \leq \tfl(a_j)$ and $\tfl(a_i') \leq \tfl(a_j')$.
  Moreover $\tfl(a_j) = \tfl(a_j')$ as $a_j, a_j'$ lie in the same subinterval (using the earlier part of the argument as $j$ is independent).
  
  \begin{Claim}
    $\val(a_i - a_i') > \tfl(a_j) - \gamma$
  \end{Claim}
  \begin{proof}
    Let $K$ be the set of the independent indices less than $i$.
    Note that by the definition for dependent indices we have $\vec p_i \in \vecspan \curly{\vec p_k}_{k \in K}$.
    We also have 
    \begin{align*}
      \val(a_k - a_k') > \tfl(a_k) \text { for all } k \in K
    \end{align*}
    as $a_k, a_k'$ lie in the same subinterval (using the earlier part of the argument as $k$ is independent).
    Now $\val(a_k - a_k') > \tfl(a_j)$  for all $k \in K$ by monotonicity of $\tfl(a_k)$.
    Moreover $a_k - a_k' = \vec p_k \cdot \vec c - \vec p_k \cdot \pvec c' = \vec p_k \cdot (\vec c - \pvec {c}')$.
    Combining the two, we get that $\val(\vec p_k \cdot (\vec c - \pvec {c}')) > \tfl(a_j)$ for all $k \in K$.
    Now observe that $K \subset I, i \in I, \vec c - \pvec {c}' \in \Q_p^{|x|}, \tfl(a_j) \in \Z$
    satisfy the requirements of Lemma \ref {gamma}, so we apply it to obtain
    $\val(\vec p_i \cdot (\vec c - \pvec {c}')) > \tfl(a_j) - \gamma$.
    Similarly to before, we have $\vec p_i \cdot (\vec c - \pvec {c}') = \vec p_i \cdot \vec c - \vec p_i \cdot \pvec {c}' = a_i - a_i'$.
    Therefore we can conclude that $\val(a_i - a_i') > \tfl(a_j) - \gamma$
    as needed, finishing the proof of the claim.
  \end{proof}	
  Additionally $a_i, a_i'$ have the same image in the $\Ct$ component, so we have
  \begin{align*}
    \val(a_i - a_i') > \tfl(a_j).
  \end{align*}
  We now would like to show that $a_i, a_i'$ lie in the same subinterval.
  As $\tfl(a_i) \leq \tfl(a_j)$, $\tfl(a_i') \leq \tfl(a_j')$ and $\tfl(a_j) = \tfl(a_j')$ we have that
  $\val(a_i - a_i') > \tfl(a_i)$ and $\val(a_i - a_i') > \tfl(a_i')$.
  Suppose that $a_i$ lies in the subinterval $\inti(t, \tfl(a_i), \alpha_U)$
  and that $a_i'$ lies in the subinterval $\inti(t', \tfl(a_i'), \alpha_U')$.
  Without loss of generality assume that $\tfl(a_i) \leq \tfl(a_i')$.
  As $\val(a_i - a_i') > \tfl(a_i')$, this implies that $a_i \in B(a_i', \tfl(a_i'))$.
  Then $a_i \in B(t', \tfl(a_i'))$ as $\vval(a_i - t') > \tfl(a_i')$.
  This implies that $B(t, \tfl(a_i)) \cap B(t', \tfl(a_i')) \neq \emptyset$ as they both contain $a_i$.
  As balls are directed, the non-zero intersection means that one ball has to be contained in another.
  Given our assumption that $\tfl(a_i) \leq \tfl(a_i')$, we have $B(t, \tfl(a_i)) \subset B(t', \tfl(a_i'))$.
  For the subintervals to be disjoint we need 
  $\inti(t, \tfl(a_i), \alpha_U) \cap B(t', \tfl(a_i')) = \emptyset$.
  But $\val(t' - a_i) > \tfl(a_i')$ implying that $a_i \in \inti(t, \tfl(a_i), \alpha_U) \cap B(t', \tfl(a_i'))$ giving a contradiction.
  Therefore the subintervals coincide finishing the proof.
\end{proof}

\begin{Corollary}
  The dual $\vc$-density of $\Phi(x,y)$ is $\leq |x|$.
\end{Corollary}

\begin{proof}
  Suppose we have $c, c' \in \Q_p^{|x|}$ such that $f(c), f(c')$ are in the same partition and $g(f(c)) = g(f(c'))$.
  Then by the previous lemma $c, c'$ have the same $\Phi$-type.
  Thus the number of possible $\Phi$-types is bounded by the size of the range of $g$ times the number of possible partitions
  
  \begin{align*}
    \text{(number of partitions)} \cdot |\It|^{|I|} \cdot |\Sub|^{|J|} \cdot |\Ct|^{|I-J|}.
  \end{align*}

  There are at most $\paren{|2I|!}^2$ many partitions of $\Sg$,
  so in the product above, the only component dependent on $B$ is

  \begin{align*}
    |\Sub|^{|J|} \leq (N \cdot 3{|I|}^2)^{|J|} = O(N^{|J|}).
  \end{align*}	
  
  Every $p_i$ is an element of a $|x|$-dimensional vector space, so there can be at most $|x|$ many independent vectors.
  Thus we have $|J| \leq |x|$ and the bound follows.
\end{proof}

\begin{Corollary} [Theorem \ref{main_theorem}]
  The $\LL_{aff}$-structure $\Q_p$ satisfies $\vc(n) = n$.
\end{Corollary}

\begin{proof}
  The previous lemma implies that $\vc^*(\phi) \leq \vc^*(\Phi) \leq |x|$.
  As choice of $\phi$ was arbitrary, this implies that the vc-density of any formula is bounded by the arity of $x$.
\end{proof}

This proof relies heavily on the linearity of the defining polynomials $a_1, a_2, c$ in the cell decomposition result (see Definition \ref{cell}).
Linearity is used to separate the $x$ and $y$ variables as well as
for Corollary \ref{gamma} to reduce the number of independent factors from $|I|$ to $|x|$.
The paper \cite{reduct} has cell decomposition results for more expressive reducts of $\Q_p$,
including, for example, restricted multiplication.
While our results don't apply to it directly,
it is this author's hope that similar techniques can be used to also compute the $\vc$-function for those structures.

Another interesting question whether the reduct studied in this paper has VC 1 property (see \cite{density} 5.2 for the definition).
If so, this would imply the linear $\vc$-density bound directly.
The paper \cite{density} implies that the reduct has VC 2 property.
While there are techniques for showing that a structure has a given VC property,
less is known about showing that a structure doesn't have a given VC property.
Perhaps the simple structure of the $\LLA$-reduct can help understand this property better.

