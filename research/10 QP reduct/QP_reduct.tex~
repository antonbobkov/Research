\documentclass{amsart}

\usepackage{../AMC_style}	
\usepackage{../Research}
\usepackage{../Thm}

\usepackage{mathrsfs}
\usepackage{pgfpages}
\usepackage{setspace}

% \doublespacing
\usepackage[margin=.75in]{geometry}
% \pgfpagesuselayout{2 on 1}

\renewcommand{\AA}{\mathscr A}
\newcommand{\BB}{\mathscr B}
\newcommand{\DD}{\mathscr D}
\newcommand{\II}{\mathscr I}
\newcommand{\MM}{\mathscr M}

\newcommand{\A}{\mathcal A}
\newcommand{\B}{\mathcal B} 
\renewcommand{\C}{\mathcal C}
\newcommand{\D}{\mathcal D}
\newcommand{\F}{\mathcal F}
\newcommand{\G}{\mathcal G}
\renewcommand{\H}{\mathcal H}
\renewcommand{\LL}{\mathcal L}
\newcommand{\LLA}{\mathcal L_{aff}}
\newcommand{\LLM}{\mathcal L_{Mac}}
\newcommand{\M}{\mathcal M}

\newcommand{\U}{\mathcal U}	


\newcommand{\curly}[1]{\left\{#1\right\}}
\newcommand{\paren}[1]{\left(#1\right)}
\newcommand{\abs}[1]{\left|#1\right|}

\providecommand{\floor}[1]{\left \lfloor #1 \right \rfloor }

\DeclareMathOperator{\Sg}{Sg}
\DeclareMathOperator{\It}{It}
\DeclareMathOperator{\Sub}{Sub}
\DeclareMathOperator{\Ct}{Ct}
\DeclareMathOperator{\vecspan}{span}
\DeclareMathOperator{\val}{val}
\DeclareMathOperator{\vval}{val}
\DeclareMathOperator{\tval}{T-val}
\DeclareMathOperator{\tbr}{T-branch}

\newcommand{\defn}{\underline}



\title{VC-density in an additive reduct of $P$-adic numbers}
\author{Anton Bobkov}
\email{bobkov@math.ucla.edu}

\begin{document}

\begin{abstract}
  Aschenbrenner et. al. computed a bound $\vc(n) \leq 2n - 1$ for the VC density function in the field of $p$-adic numbers,
  but it is not known to be optimal.
  I investigate a certain $P$-minimal additive reduct of the field of $p$-adic numbers and
  use a cell decomposition result of Leenknegt to compute an optimal bound $\vc(n) = n$ for that structure.
\end{abstract}


\maketitle

VC density was introduced into model theory in \cite{density} by Aschenbrenner, Dolich, Haskell, MacPherson, and Starchenko
as a natural notion of dimension for definable families of sets in NIP theories.
In a NIP theory $T$ we can define the vc-function

\begin{align*}
  \vc_T = \vc : \N \arr \N
\end{align*}

where $\vc(n)$ measures the worst-case complexity of families of definable sets in an $n$-dimensional space.
The simplest possible behavior is $\vc(n) = n$ for all $n$.
For $T = \Th(\Q_p)$, the paper \cite{density} computes an upper bound for this function to be $2n-1$, and it is not known whether it is optimal.
This same bound would hold in any reduct of the field of $p$-adic numbers, so one may expect that the simplified structure of the reduct would allow a better bound.
In \cite{reduct}, Leenknegt provides a cell decomposition result for a certain P-minimal additive reduct of the field $p$-adic numbers.
Using this result, in this paper we improve the bound for the VC function, showing that in Leenknegt's structure $\vc(n) = n$.

Section 1 defines VC-density and states some basic lemmas about it.
More in depth exposition of VC-density can be found in \cite{density}.
Section 2 defines and states some basic facts about thoery of $p$-adic numbers.
Here we also introduce the reduct we will be working with.
Section 3 sets up basic definition and lemmas that will be needed for the proof.
We define trees and intervals and show how it helps with VC-density calculations.
Section 4 concludes the proof.

Throughout the paper, variables and tuples of elements will be simply denoted as $x, y, a, b, \ldots$.
We will occasionally write $\vec a$ instead of $a$ for a tuple in $\Q_p^n$ to emphasize it as an element of $\Q_p$-vector space $\Q_p^n$.
$|x|$ refers to the arity of the variable.
First-order formulas will have parameter variables separated $\phi(x; y)$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

\section{VC-dimension and VC-density}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 



\begin{Definition}
  Throughout this section we work with a collection $\F$ of subsets of a set $X$.
  We call the pair $(X, \F)$ a \defn{set system}.
  \begin{itemize}
  \item Given a subset $A$ of $X$, we define the set system $(A, A \cap \F)$
    where $A \cap \F = \curly{A \cap F}_{F\in \F}$.
  \item For $A \subset X$ we say that $\F$ \defn{shatters} $A$ if $A \cap \F = \PP(A)$.
  \end{itemize}    
\end{Definition}  

\begin{Definition}
  We say $(X, \F)$ has VC-dimension $n$ if the largest subset of $X$ shattered by $\F$ is of size $n$.
  If $\F$ shatters arbitrarily large subsets of $X$, we say that $(x, \F)$ has infinite VC-dimension.
  We denote the VC-dimension of $(X, \F)$ by $\VC(\F)$.
\end{Definition}  

\begin{Note}
  We may drop $X$ from the previous definition, as it VC-dimension doesn't depend on the base set and is determined by $(\bigcup \F, \F)$.
\end{Note}
This allows us to distinguish between well behaved set systems of finite VC-dimension which tend to have good combinatorial properties and
poorly behaved set systems with infinite VC dimension.

Another natural combinatorial notion is that of a dual system:
\begin{Definition}
  For $a \in X$ define $X_a = \curly{F \in \F \mid a \in F}$.
  Let $\F^* = \curly{X_a}_{a \in X}$.
  We define $(\F, \F^*)$ as the \defn{dual system} of $(X, \F)$.
  The VC-dimension of the dual system of $(X, \F)$ is referred to as the \defn{dual VC-dimension} of $(X, \F)$ and denoted by $\VC^*(\F)$.
  (As before, this notion doesn't depend on $X$.)
\end{Definition}  

\begin{Lemma}
  A set system has finite VC-dimension if and only if its dual system has finite VC-dimension.
  More precisely
  \begin{align*}
    \VC^*(\F) \leq 2^{1+\VC(\F)}.
  \end{align*}
\end{Lemma}

For a more refined notion we look at the traces of our family on finite sets:
\begin{Definition}
  Define the \defn{shatter function} $\pi_\F \colon \N \arr \N$ and the \defn{dual shatter function} $\pi^*_\F \colon \N \arr \N$ of $\F$ by 
  \begin{align*}
    \pi_\F(n) &= \max \curly{|A \cap \F| \mid A \subset X \text{ and } |A| = n} \\
    \pi^*_\F(n) &= \max \curly{\text{number of atoms in Boolean algebra generated by $B$} \mid B \subset \F, |B| = n}
  \end{align*}
  Note that the dual shatter function is precisely the shatter function of the dual system: $\pi^*_\F = \pi_{\F^*}$
\end{Definition}  

A simple upper bound is $\pi_\F(n) \leq 2^n$ (same for the dual).
If VC-dimension is infinite then clearly $\pi_\F(n) = 2^n$ for all $n$. Conversely we have the following remarkable fact:
\begin{Theorem} [Sauer-Shelah '72]
  If the set system $(X, \F)$ has finite VC-dimension $d$ then $\pi_\F(n) \leq {n \choose \leq d}$ where
  ${n \choose \leq d} = {n \choose d} + {n \choose d - 1} + \ldots + {n \choose 1}$.    
\end{Theorem}

Thus the systems with a finite VC-dimension are precisely the systems where the shatter function grows polynomially.
Define VC-density to be the degree of that polynomial:
\begin{Definition}
  Define \defn{vc-density} and \defn{dual vc-density} of $\F$ as
  \begin{align*}
    \vc(\F) &= \limsup_{n \to \infty}\frac{\log \pi_\F(n)}{\log n} \in \R^{\geq 0} \cup \curly{+\infty}\\
    \vc^*(\F) &= \limsup_{n \to \infty}\frac{\log \pi^*_\F(n)}{\log n}\in \R^{\geq 0} \cup \curly{+\infty}
  \end{align*}
\end{Definition}

Generally speaking a shatter function that is bounded by a polynomial doesn't itself have to be a polynomial.
Proposition 4.12 in \cite{density} gives an example of a shatter function that grows like $n \log n$ (so it has VC-density $1$).

So far the notions that we have defined are purely combinatorial.
We now adapt VC-dimension and VC-density to the model theoretic context.

\begin{Definition}
  Work in a structure $M$.
  Fix a finite collection of formulas $\Phi(x, y) = \curly{\phi_i(x, y)}$.

  \begin{itemize}
  \item For $\phi(x, y) \in \LL(M)$ and $b \in M^{|y|}$ let $\phi(M^{|x|}, b) = \{a \in M^{|x|} \mid \phi(a, b)\} \subseteq M^{|x|}$.
  \item Let $\Phi(M^{|x|}, M^{|y|})= \{\phi_i(M^{|x|}, b) \mid \phi_i \in \Phi, b \in M^{|y|}\} \subseteq \PP(M^{|x|})$.
  \item Let $\F_\Phi = \Phi(M^{|x|}, M^{|y|})$ giving a set system $(M^{|x|}, \F_\Phi)$.
  \item Define \defn{VC-dimension} of $\Phi$, $\VC(\Phi)$ to be the dual VC-dimension of $(M^{|x|}, \F_\Phi)$.
  \item Define \defn{VC-density} of $\Phi$, $\vc(\Phi)$ to be the dual VC-density of $(M^{|x|}, \F_\Phi)$.
  \end{itemize}

  We will also refer to the VC-density and VC-dimension of a single formula $\phi$
  viewing it as a one element collection $\curly{\phi}$.
\end{Definition}

Counting atoms of a Boolean algebra in a model theoretic setting corresponds to counting types,
so it is instructive to rewrite the shatter function in terms of types.

\begin{Definition} 
  \begin{align*}
    \pi_\Phi(n) &= \max \curly{\text{number of $\Phi$-types over $B$} \mid B \subset M, |B| = n}
  \end{align*}
\end{Definition}  

\begin{Lemma} \label{count_types}
  \begin{align*}
    \vc(\Phi) &= \text{degree of polynomial growth of $\pi_\Phi(n)$}  = \limsup_{n \to \infty}\frac{\log \pi_\Phi(n)}{\log n}
  \end{align*}  
\end{Lemma}

One can check that the shatter function and hence VC-dimension and VC-density of a formula are elementary notions,
so they only depend on the first-order theory of the structure.

NIP theories are a natural context for studying VC-density.
In fact we can take the following as the definition of NIP:
\begin{Definition}
  Define $\phi$ to be NIP if it has finite VC-dimension. 
\end{Definition}

\cite{Aschenbrenner_reference_8} shows that in a general combinatorial context,
VC-density can be any real number in $0 \cup [1, \infty)$.
Less is known if we restrict our attention to NIP theories.
Proposition 4.6 in \cite{density} gives examples of formulas that have non-integer rational VC-density in an NIP theory,
however it is open whether one can get an irrational VC-density in this context.

In general, instead of working with a theory formula by formula, we can look for a uniform bound for all formulas:
\begin{Definition}
  For a given NIP structure $M$, define the \defn{vc-function}
  \begin{align*}
    \vc^M(n) = \sup \{\vc(\phi(x, y)) \mid \phi \in \LL(M), |x| = n\}
  \end{align*}
\end{Definition}

As before this definition is elementary, so it only depends on the theory of $M$.
We omit the superscript $M$ if it is understood from the context.
One can easily check the following bounds:
\begin{Lemma} [Lemma 3.22 in \cite{density}]
  \begin{align*}
    \vc(1) &\geq 1 \\
    \vc(n) &\geq n\vc(1)
  \end{align*}  
\end{Lemma}

However, it is not known whether the second inequality can be strict or even whether $\vc(1) < \infty$ implies $\vc(n) < \infty$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

\section{$P$-adic numbers}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

The field of $p$-adic numbers is often studied in the language of Macintyre $\LLM = \curly{0, 1, +, -, \cdot, |, \{P_n\}_{n \in \N}}$
which is a language of fields together with unary predicates $P_n$ interpreted in $\Q_p$ by

\begin{align*}
  P_n x \leftrightarrow \exists y \; y^n = x
\end{align*}

and a divisibility relation where $a|b$ holds when $\vval a \leq \vval b$.

Note that $P_n\backslash \curly{0}$ is a multiplicative subgroup of $\Q_p$ with finitely many cosets.

\begin{Theorem} [Macintyre '76]
  The $\LLM$-structure $\Q_p$ has quantifier elimination.
\end{Theorem}

There is also a cell decomposition result:
\begin{Definition}
  Define \defn{$k$-cell} recursively.
  $0$-cells are points in $\Q_p$.
  An $(k+1)$-cell is a subset of $\Q_p^{k+1}$ of the following form:
  \begin{align*}
    \curly{(x, t) \in D \times \Q_p \mid \vval a_1(x) \ \square_1 \vval (t - c(x)) \ \square_2 \vval a_2(x), t - c(x) \in \lambda P_n}
  \end{align*}
  where $D$ is an $k$-cell,
  $a_1(x), a_2(x), c(x)$ are $\emptyset$-definable,
  $\square$ is $<, \leq$ or no condition, and
  $\lambda \in \Q_p$.    
\end{Definition}

\begin{Theorem} [Denef '84]
  Any subset of $\Q_p$ defined by a $\LLM$-formula $\phi(x, t)$ with $|x| = n$ and $|t| = 1$ decomposes into a finite union of $(k+1)$-cells.
\end{Theorem}  

In \cite{density}, Aschenbrenner, Dolich, Haskell, Macpherson, and Starchenko show that this structure has $\vc(n) \leq 2n - 1$,
however it is not known whether this bound is optimal.

In \cite{reduct}, Leenknegt analyzes the reduct of $p$-adic numbers to the language
\begin{align*}
  \LL_{aff}  = \curly{0, 1, +, -, \curly{\bar c}_{c \in \Q_p}, |, \curly{Q_{m,n}}_{m,n\in \N}}
\end{align*}
where $\bar c$ is a scalar multiplication by $c$,
$a | b$ stands for $\vval a \leq \vval b$,
and $Q_{m,n}$ is a unary predicate
\begin{align*}
  Q_{m,n} = \bigcup_{k \in \Z} p^{km} (1 + p^n\Z_p).
\end{align*}
Note that $Q_{m,n} \backslash \curly{0}$ is a subgroup of the multiplicative group of $\Q_p$ with finitely many cosets.
One can check that the extra relation symbols are definable in the $\LLM$-structure $\Q_p$.
The paper \cite{reduct} provides a cell decomposition result with the following cells:

\begin{Definition} \label{cell}
  A $0$-cell is a point in $\Q_p$.
  An $(k+1)$-cell is a subset of $\Q_p^{k+1}$ of the following form:
  \begin{align*}
    \curly{(x, t) \in D \times \Q_p \mid \vval a_1(x) \ \square_1 \vval (t - c(x)) \ \square_2 \vval a_2(x), t - c(x) \in \lambda Q_{m,n} }
  \end{align*}
  where $D$ is an $k$-cell called the \defn{base} of the cell,
  $a_1(x), a_2(x), c(x)$ are degree $\leq 1$ polynomials,
  $\square$ is $<$ or no condition, and
  $\lambda  \in\Q_p$.
\end{Definition}

\begin{Theorem}[Leenknegt '12] 
  Any formula $\phi(x, t)$ in $(\Q_p, \LL_{aff})$ with $|x| = n$ and $|t| = 1$ decomposes into a union of $(k+1)$-cells.
\end{Theorem}  

Moreover, \cite{reduct} shows that $(\Q_p, \LL_{aff})$ is a $P$-minimal reduct,
that is the one-dimensional definable sets of $(\Q_p, \LL_{aff})$ coincide with the one-dimensional definable sets in the full structure $(\Q_p, \LLM)$.

I am able to compute the $\vc$-function for this structure:
\begin{Theorem} \label{main_theorem}
  $(\Q_p, \LL_{aff})$ has $\vc(n) = n$.
\end{Theorem}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

\section{Key Lemmas and Definitions}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 



To show that $\vc(n) = n$ it suffices to bound $\vc(\phi) \leq |x|$ for every formula $\phi(x; y)$.
Fix such a formula $\phi(x; y)$.
Instead of working with it directly, we simplify it using quantifier elimination.
The quantifier elimination result can be easily obtained from cell decomposition:
\begin{Lemma} \label{quantifier_elimination}
  Any formula $\phi(x; y)$ in $(\Q_p, \LL_{aff})$ can be written as a boolean combination of formulas from the following collection
  \begin{align*}
    \Phi(x; y) = &\curly{\vval (p_i(x) - c_i(y)) < \vval (p_j(x) - c_j(y))}_{i, j \in I} \cup \\
                 &\curly{p_i(x) - c_i(y) \in \lambda_k Q_{m,n}}_{i \in I , k \in K}
  \end{align*}
  where $I, K$ are finite index sets,
  each $p_i$ is a degree $\leq 1$ polynomial in $x$ without a constant term,
  each $c_i$ is a degree $\leq 1$ polynomial in $y$, and
  $\lambda_k \in \Q_p$.
\end{Lemma}

\begin{proof}
  Let $l = |x| + |y|$.
  Apply the cell decomposition theorem to $\phi(x; y)$ to obtain $\DD^l$, a collection of $l$-cells.
  Let $\DD^{l-1}$ be a collection $l-1$ of bases of cells in $\DD^l$.
  Similarly, construct by induction $\DD^i$ for each $0 \leq j < l$,
  where $\DD_j$ is a collection of $j$-cells which are the bases of cells in $\DD_{j+1}$.
  Let $\DD = \bigcup \DD_j$.
  Choose $m,n$ large enough to cover all $n', m'$ for $Q_{n',m'}$ that show up in the cells of $\DD$.
  Choose $\lambda_k$ to go over all the cosets of $Q_{m,n}$.
  Let $q_i(x, y)$ enumerate all of the polynomials $a_1(x), a_2(x), t - c(x)$ that show up in the cells of $\DD$.
  Those are all polynomials of degree $\leq 1$ in variables $x, y$.
  We can split each of them as $q_i(x,y) = p_i(x) - c_j(y)$ where the constant term goes into $c_j$.
  This gives us the appropriate finite collection of formulas $\Phi$.
  From the cell decomposition it is easy to see that when $a, a'$ have the same $\Phi$-type,
  then they have the same $\phi$-type.
  Thus $\phi$ can be written as a boolean combination of formulas from $\Phi$.
\end{proof}

\begin{Lemma}
  If $\phi$ can be written as a boolean combination of formulas from $\Phi$ then
  \begin{align*}
    \vc (\Phi) \leq n \implies \vc (\phi) \leq n
  \end{align*}
\end{Lemma}
\begin{proof}
  If $a,a'$ have the same $\Phi$-type over $B$, then they have the same $\phi$-type over $B$, where $B$ is some parameter set.
  Therefore the number of $\phi$-types is bounded by the number of $\Phi$-types.
  The bound follows from Lemma \ref{count_types}.
\end{proof}

Therefore to show that $\vc(\phi) \leq |x|$, it suffices to bound $\vc(\Phi) \leq |x|$.
More precisely, it is sufficient to show that if there is a parameter set $B$ of size $N$
then the number of $\Phi$-types over $B$ is $O(N^{|x|})$.
Fix such a parameter set $B$ and work with it from now on.
We will compute a bound for the number of $\Phi$-types over $B$.

Consider a set $T = \curly{c_i(b) \mid b \in B, i \in I} \subset \Q_p$.
In this definition $B$ is the parameter set that we fixed 
and $c_i(b)$ come from the collection of formulas $\Phi$ from the quantifier elimination above.
View $T$ as a tree as follows:
\begin{Definition} \ 
  \begin{itemize}
  \item For $c \in \Q_p, \alpha \in \Z$  define a \defn{ball} 
    \begin{align*}
      B(c, \alpha) = \curly{c' \in \Q_p \mid \vval \paren{c' - c} \geq \alpha}.  
    \end{align*}
    % \item \defn{interval-balls} is a collection of balls $\BB = \curly{B(t_1, \vval(t_1 - t_2))}_{t_1, t_2 \in T}$.
  \item Define a collection of balls $\BB = \curly{B(t_1, \vval(t_1 - t_2))}_{t_1, t_2 \in T}$.
    An \defn{interval} $(B_1, B_2)$ is a set $B_1 \backslash B_2$
    for $B_1, B_2 \in \BB$ with $B_1 \supset B_2$ and no balls from $\BB$ in between.
    % We also define an interval $(-\infty, B)$ as a set $\Q_p \backslash B$ for a ball $B(c, v) \in \BB$
    % with the smallest valuation $v$ of all the balls in $\BB$.
    % An element $a \in \Q_p$ belongs to this interval if $a \in B(t_1, v_1) \backslash B(t_2, v_2)$.
    Note that intervals partition $\Q_p$.
  \item Define a collection of balls 
    \begin{align*}
      \BB' = \BB \cup \curly{B(c_{i_1}(b), \vval(c_{i_2}(b) - c_{i_3}(b)))}_{i_1, i_2, i_3 \in I, b\in B}.  
    \end{align*}
    A \defn{sub-interval} is defined the same as an interval except using collection $\BB'$ instead of $\BB$.
    Sub-intervals refine intervals.
  \end{itemize}
\end{Definition}

\begin{Lemma} \label{interval_count}\ 
  \begin{itemize}
  \item 
    There are at most $2|T| = 2 N |I| = O(N)$ different intervals.
  \item 
    There are at most $2|T| + |B| \cdot |I|^3 = O(N)$ different sub-intervals.
  \end{itemize}
\end{Lemma}

\begin{proof}
  Each new element in the tree $T$ adds at most two intervals to the total count,
  so by induction there can be at most $2|T|$ many intervals.
  Each new ball in $\BB' \backslash \BB$ adds at most one interval to the total count,
  so by induction there are at most $|\BB' \backslash \BB|$ more sub-intervals than there are intervals.
\end{proof}

\begin{Definition}
  Suppose $a \in \Q_p$ lies in an interval $\paren{B(t_L, \alpha_L),  B(t_U, \alpha_U)}$.
  \begin{itemize}
  \item Define \defn{T-branch} of $a$ to be $\tbr(a) = t_U$.    
  \item Define \defn{T-valuation} of $a$ to be $\tval(a) = \vval(a - t_U)$.    
  % \item Define the \defn{floor} of $a$ to be $F(a) = \alpha_L$.
  \item We say that $a$ is \defn{close to boundary} if $|\tval(a) - \alpha_L| \leq n$ or $|\tval(a) - \alpha_U| \leq n$.
    Otherwise we say that it is \defn{far from boundary}.
  \end{itemize}      
\end{Definition}

\begin{Definition}
  Suppose $a_1, a_2 \in \Q_p$ lie in our tree in the same interval $\paren{B(t_L, \alpha_L),  B(t_U, \alpha_U)}$.
  We say $a_1, a_2$ have the same \defn{interval type} if one of the following holds:
  \begin{itemize}
  \item Both $a_1, a_2$ are far from boundary and $a_1 - t_U, a_2 - t_U$ are in the same $Q_{m,n}$ coset.
  \item Both $a_1, a_2$ are close to boundary and $\vval(a_1 - a_2) > \tval(a_1) + n = \tval(a_2) + n$.
  \end{itemize}      
\end{Definition}


\begin{Definition}
  For $c \in \Q_p$ and $\alpha, \beta \in \Z$ define $c \midr [\alpha, \beta] \in \paren{\Z/p\Z}^{\beta - \alpha}$
  to be the record of the coefficients of $c$ for the valuations between $[\alpha, \beta)$.
  More precisely write $c$ in its power series form
  \begin{align*}
    c = \sum_{\gamma \in \Z} c_\gamma p^\gamma \text{ with } c_\gamma \in \Z/p\Z
  \end{align*}
  Then $c \midr [\alpha, \beta]$ is just $(c_\alpha, c_{\alpha+1}, \ldots c_{\beta - 1})$.
\end{Definition}

The following lemma is an adaptation of lemma 7.4 in \cite{density}.
\begin{Lemma} \label{distance}
  Fix $m,n \in \N$.
  For any $x,y,c \in \Q_p$, if
  \begin{align*}
    \val (x - c) = \val (y - c) < \val (x - y) - n,
  \end{align*}
  then $x - c, y - c$ are in the same coset of $Q_{m,n}$.
\end{Lemma}
\begin{proof}
  Call $a,b \in \Q_p$ similar if $\val a = \val b$ and
  \begin{align*}
    a \midr [\val a, \val a + n] = b \midr [\val b, \val b + n]
  \end{align*}
  If $a,b$ are similar then
  \begin{align*}
    a \in Q_{m,n} \leftrightarrow b \in Q_{m,n}
  \end{align*}
  Moreover for any $\lambda \in \Q_p^\times$, if $a,b$ are similar then so are $\lambda a, \lambda b$.
  Thus if $a,b$ are similar, then they belong to the same coset of $Q_{m,n}$.
  Conditions of the lemma force $x - c, y - c$ to be similar, thus belonging to the same coset.
\end{proof} 


\begin{Lemma} \label{interval_type_count}
  For each interval there are at most $K = K(Q_{m,n})$ many interval types 
  (with $K$ not dependent on $B$ or the interval).  
\end{Lemma}

\begin{proof}
  Let $a, a' \in \Q_p$ lie in the same interval $\paren{B(t_L, \alpha_L),  B(t_U, \alpha_U)}$.

  Suppose $a, a'$ are far from boundary.
  Then they have the same interval type if $a - t_U, a' - t_U$ are in the same $Q_{m,n}$-coset.
  Number of such interval types is bounded by the number of $Q_{m,n}$-cosets.

  Suppose $a, a'$ are close to boundary and
  \begin{align*}
    &|\tval(a) - \alpha_L| = |\tval(a') - \alpha_L| \leq n \\
    &a \midr [\tval(a), \tval(a) + n] = a' \midr [\tval(a'), \tval(a') + n]  
  \end{align*}
  Then $a, a'$ have the same interval type.
  Such interval type is thus determined by $|\tval(a) - \alpha_L|$ and $a \midr [\tval(a), \tval(a) + n]$,
  therefore there are at most $n p^n$ many such types.

  A similar argument works for $a$ with $|\tval(a) - \alpha_U| \leq n$.

  Adding those up we get that there are at most
  \begin{align*}
    K = \text{(number of $Q_{m,n}$ cosets)} + 2 n p^n  
  \end{align*}
  many interval types.
\end{proof}

\begin{Lemma} \label{main_lemma}
  Suppose $d, d' \in \Q_p^{|x|}$ satisfy the follwing three conditions 
  \begin{itemize}
  \item For all $i \in I$ $p_i(d)$ and $p_i(d')$ are in the same sub-interval.
  \item For all $i \in I$ $p_i(d)$ and $p_i(d')$ have the same interval type.
  \item For all $i,j \in I$, $\tval(p_i(d)) > \tval(p_j(d))$ iff $\tval(p_i(d')) > \tval(p_j(d'))$.
  \end{itemize}
  Then $d, d'$ have the same $\Phi$-type over $B$.
\end{Lemma}
\begin{proof}
  There are two kinds of formulas in $\Phi$
  (see Lemma \ref{quantifier_elimination}).
  First we show that $d, d'$ agree on formulas of the form $p_i(x) - c_i(y) \in \lambda_k Q_{m,n}$.
  It is enough to show that for every $i \in I, b \in B$ we have $p_i(d) - c_i(b), p_i(d') - c_i(b)$ are in the same $Q_{m,n}$-coset.
  Fix such $i, b$.
  For brievety let $a = p_i(d), a' = p_i(d')$ and $Q = Q_{m,n}$.
  We want to show that $a - c_i(b), a' - c_i(b)$ are in the same $Q$-coset.
  
  Suppose $a, a'$ are close to boundary.
  Then we have $\val(a - c_i(b)) = \val(a' - c_i(b)) < \val(a - a') - n$.
  By Lemma \ref{distance} we have $a - c_i(b), a' - c_i(b)$ in the same $Q$-coset.
  
  Now, suppose both $a, a'$ are far from boundary.
  Label their interval as $B(t_L, \alpha_L) \backslash B(t_U, \alpha_U)$.
  Then we have 
  \begin{align*}
    \alpha_L + n < &\val (a - t_U) < \alpha_U - n \\
    \alpha_L + n < &\val (a' - t_U) < \alpha_U - n
  \end{align*}
  We have either $\val(t_U - c_i(b)) \geq \alpha_U$ or $\val(t_U - c_i(b)) \leq \alpha_L$
  as otherwise it would contradict the definition of an interval.
  
  Suppose it is the first case $\val(t_U - c_i(b)) \geq \alpha_U$.
  Then
  \begin{align*}
    \val(a - c_i(b)) = \val(a - t_U) < \alpha_U - n \leq \val(t_U - c_i(b)) - n
  \end{align*}
  so by Lemma \ref{distance} we have $a - c_i(b), a - t_U$ are in the same $Q$-coset.
  By a parallel argument we have $a' - c_i(b), a' - t_U$ are in the same $Q$-coset.
  As $a, a'$ have the same interval type, $a - t_U, a' - t_U$ are in the same $Q$-coset.
  Thus by transitivity we get that $a - c_i(b), a' - c_i(b)$ are in the same $Q$-coset.
  
  For the second case, suppose $\val(t_U - c_i(b)) \leq \alpha_L$.
  Then
  \begin{align*}
    \val(a - c_i(b)) = \val(t_U - c_i(b)) \leq \alpha_L < \val(a - t_U) - n
  \end{align*}
  so by Lemma \ref{distance} we have $a - c_i(b), t_U - c_i(b)$ are in the same $Q$-coset.
  By a parallel argument we have $a' - c_i(b), t_U - c_i(b)$ are in the same $Q$-coset.
  Thus by transitivity we get that $a - c_i(b), a' - c_i(b)$ are in the same $Q$-coset.

  Next, we need to show that $d, d'$ agree on formulas of the form
  $\vval (p_i(x) - c_i(y)) < \vval (p_j(x) - c_j(y))$ 
  (see Lemma \ref{quantifier_elimination}).
  Fix $i,j \in I, b \in B$.
  We would like to show that 
  \begin{align*} \label {order_equation}
    \vval (p_i(d) - c_i(b)) < \vval (p_j(d) - c_j(b))  \iff \vval (p_i(d') - c_i(b)) < \vval (p_j(d') - c_j(b))
  \end{align*}

  For the following argument we will need more notation.
  Suppose $a \in \Q_p$ lies in an interval $\paren{B(t_L, \alpha_L),  B(t_U, \alpha_U)}$.
  Then let \defn{T-branch} of $a$ be $\tbr(a) = t_U$.    
  Consider the following 4 cases.

  Case 1:
  \begin{align*}
    &\vval (p_i(d) - c_i(b)) = \vval (p_i(d') - c_i(b)) = \vval(\tbr(p_i(d)) - c_i(b)) \\
    &\vval (p_j(d) - c_j(b)) = \vval (p_j(d') - c_j(b)) = \vval(\tbr(p_j(d)) - c_j(b))  \\
  \end{align*}
  Then it is clear that \ref{order_equation} holds.

  Case 2:
  \begin{align*}
    &\vval (p_i(d) - c_i(b)) = \tval(p_i(d)) \text{ and } \vval (p_i(d') - c_i(b)) = \tval(p_i(d')) \\
    &\vval (p_j(d) - c_j(b)) = \tval(p_j(d)) \text{ and } \vval (p_j(d') - c_j(b)) = \tval(p_j(d')) \\
  \end{align*}
  Then the order is preserved by the condition of the lemma statement that order of T-valuations is preserved.

  Case 3:
  \begin{align*}
    &\vval (p_i(d) - c_i(b)) = \vval (p_i(d') - c_i(b)) = \vval(\tbr(p_i(d)) - c_i(b)) \\
    &\vval (p_j(d) - c_j(b)) = \tval(p_j(d)) \text{ and } \vval (p_j(d') - c_j(b)) = \tval(p_j(d')) \\
  \end{align*}
  If $p_j(d), p_j(d')$ are close to boundary,
  then $\tval(p_j(d)) = \tval(p_j(d'))$ and \ref{order_equation} clearly holds.
  Suppose then that $p_j(d), p_j(d')$ are far from boundary.
  Suppose that $p_j(d), p_j(d')$ lie in the sub-interval $\paren{B(t_L, \alpha_L),  B(t_U, \alpha_U)}$.
  Then $\tval(p_j(d)), \tval(p_j(d)') \in (\alpha_L, \alpha_U)$ (as an interval in $\Z$)
  and $\vval(\tbr(p_i(d)) - c_i(b))$ lies outside of $(\alpha_L, \alpha_U)$ by definition of sub-interval.
  Therefore \ref{order_equation} has to hold.
  (Note that we always have $\tval(p_j(d)), \tval(p_j(d)') \in (\alpha_L, \alpha_U]$,
  we need the far from boundary condition to avoid equality to $\alpha_U$.)

  Case 4:
  \begin{align*}
    &\vval (p_i(d) - c_i(b)) = \tval(p_i(d)) \text{ and } \vval (p_i(d') - c_i(b)) = \tval(p_i(d')) \\
    &\vval (p_j(d) - c_j(b)) = \vval (p_j(d') - c_j(b)) = \vval(\tbr(p_j(d)) - c_j(b)) \\
  \end{align*}
  Similar to case 3.
\end{proof}



\begin{Note}
  This gives us an upper bound on the number of types - there are at most $|2I|!$ many choices for the order of $\tval$,
  $O(N)$ many choices for the sub-interval for each $p_i$,
  and $K$ many choices for the interval type for each $p_i$,
  giving a total of $O(N^{|I|}) \cdot K^{|I|} \cdot |I|! = O(N^{|I|})$ many types.
  This implies $\vc(\Phi) \leq |I|$.
  The biggest contribution to this bound are the choices among the $O(N)$ many sub-intervals for each $p_i$ with $i \in I$.
  Are all of those choices realized?
  Intuitively there are $|x|$ many variables and $|I|$ many equations,
  so once we choose an sub-interval for $|x|$ many $p_i$'s, the sub-interval for the rest should be determined.
  This would give the required $\vc(\Phi) \leq |x|$ bound.
  The next section outlines this idea formally.
\end{Note}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

\section{Main Proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

Alternative way to write $p_i(c)$ is $\vec p_i \cdot \vec c$,
where $\vec p_i$ and $\vec c$ are vectors in $\Q_p^{|x|}$ (as $p_i(x)$ is linear).

\begin{Lemma}	 \label{gamma}
  Suppose we have a finite collection of vectors $\curly{\vec p_i}_{i \in I}$ with each $\vec p_i \in \Q_p^{|x|}$.
  Suppose $J \subset I$ and $i \in I$ satisfy
  \begin{align*}
    \vec p_i \in \vecspan \curly{\vec p_j}_{j \in J}, 
  \end{align*}
  and we have $\vec c \in \Q_p^{|x|}, \alpha \in \Z$ with
  \begin{align*}
    \val(\vec p_j \cdot \vec c) > \alpha \text{ for all } j \in J
  \end{align*}
  Then
  \begin{align*}
    \val(\vec p_i \cdot \vec c) > \alpha - \gamma
  \end{align*}
  for some $\gamma \in \N$.
  Moreover $\gamma$ can be chosen independently from $J, j, \vec c, \alpha$ depending only on $\curly{\vec p_i}_{i \in I}$.
\end{Lemma}

\begin{proof}
  Fix $i, J$ satisfying the conditions of the lemma.
  For some $c_j \in \Q_p$ for $j \in J$ we have
  \begin{align*}
    \vec p_i &= \sum_{j \in J} c_j \vec p_j,
  \end{align*}
  hence
  \begin{align*}
    \vec p_i \cdot \vec c &= \sum_{j \in J} c_j \vec p_j \cdot \vec c.
  \end{align*}
  We have
  \begin{align*}
    \val \paren{c_j \vec p_j \cdot \vec c} = \val \paren{c_j} + \val \paren{\vec p_j \cdot \vec c} > \val \paren{c_j} + \alpha.
  \end{align*}
  % Pick $\gamma = -\max \val \paren{c_i}$ or $0$ if all those values are positive.
  Let $\gamma = \max(0, -\max_{j \in J} \val \paren{c_j})$.
  % Let $\gamma = -\min(0, \max_{j \in J} \val \paren{c_j})$.
  % Let $\gamma = \max(0, \min -\val \paren{c_j})$.
  Then we have 
  \begin{align*}
    &\val \paren{c_j \vec p_j \cdot \vec c} > \alpha - \gamma \text{ for all $j \in J$}\\
    &\val \paren{\sum_{j \in J} c_j \vec p_j \cdot \vec c} > \alpha - \gamma \\
    &\val(\vec p_i \cdot \vec c) > \alpha - \gamma
  \end{align*}
  This shows that we can pick such $\gamma$ for a given choice of $i, J$, but independent from $\alpha, \vec c$.
  To get a choice independent from $i, J$, go over all such eligible choices 
  ($i$ ranges over $I$ and $J$ ranges over subsets of $I$),
  pick $\gamma$ for each, and then take the maximum of those values.
\end{proof}

Fix $\gamma$ according to Lemma \ref{gamma} corresponding to $\curly{\vec p_i}_{i \in I}$ given by our collection of formulas $\Phi$.
(The lemma above is a general result, but we only use it applied to the vectors given by $\Phi$.)

\begin{Definition}
  Suppose $a \in \Q_p$ lies in a sub-interval $\paren{B(t_L, \alpha_L),  B(t_U, \alpha_U)}$.
  Define \defn{floor} of $a$ to be $F(a) = \alpha_L$.
\end{Definition}

\begin{Definition}
  Let $f: \Q_p^{|x|} \arr \Q_p^I$ with $f(c) = (p_i(c))_{i \in I}$.
  Define the segment space $\Sg$ to be the image of $f$.	
\end{Definition}

Given a tuple $(a_i)_{i\in I}$ in the segment space,
look at the corresponding floors $\curly{F(a_i)}_{i\in I}$ and T-valuations $\curly{\tval(a_i)}_{i\in I}$.
Partition the segment space by the order types of $\{F(a_i)\}_{i\in I}$ and $\curly{\tval(a_i)}_{i\in I}$ (as subsets of $\Z$).

Work in a fixed partition $\Sg'$.
After relabeling we may assume that
\begin{align*}
  F(a_1) \geq F(a_2) \geq \ldots 
\end{align*}

Consider the (relabeled) sequence of vectors $\vec p_1, \vec p_2, \ldots, \vec p_I$.
There is a unique subset $J \subset I$ such that all vectors with indices in $J$ are linearly independent,
and all vectors with indices outside of $J$ are a linear combination of preceding vectors.
For any index $i \in I$ we call it \defn{independent} if $i \in J$ and we call it \defn{dependent} otherwise.


\begin{Definition} \ 
  \begin{itemize}
  \item Denote $\Z/p\Z^\gamma$ as \defn{$\Ct$}.
    Note that $|\Ct| = p^\gamma$.
  \item Let \defn{$\It$} be the space of all interval types.
    By Lemma \ref{interval_type_count} $|\It| \leq K$.
  \item Let \defn{$\Sub$} be the space of all sub-intervals.
    By Lemma \ref{interval_count} $|\Sub| \leq 3 |I|^2 \cdot N = O(N)$.
  \end{itemize}
\end{Definition}

\begin{Definition}
  Now, we define the following function
  \begin{align*}
    g_{\Sg'}: \Sg' \arr \It^I \times \Sub^J \times \Ct^{I \backslash J}
  \end{align*}

  Let $a = (a_i)_{i\in I} \in \Sg'$.
  To define $g_{\Sg'}(a)$ we need to specify where it maps $a$ in each individual component of the product.

  For each $a_i$ record its interval type, giving the first component $\It^I$.

  For $a_j$ with $j \in J$, record the sub-interval of $a_j$, giving the second component $\Sub^J$.

  For the third component $\Ct^{I \backslash J}$ do the following computation.
  Pick $a_i$ with $i$ dependent.
  Let $j$ be the largest independent index with $j < i$.
  Record $a_i \midr [F(a_j) - \gamma, F(a_j)]$.

  Combine $g_{\Sg'}$ for all the partitions to get a function 
  \begin{align*}
    g: \Sg \arr \It^I \times \Sub^J \times \Ct^{I \backslash J}.  
  \end{align*}
\end{Definition}

\begin{Lemma}
  Suppose we have $c, c' \in \Q_p^{|x|}$ such that $f(c), f(c')$ are in the same partition and $g(f(c)) = g(f(c'))$.
  Then $c, c'$ have the same $\Phi$-type over $B$.
\end{Lemma}

\begin{proof}
  Let $a_i = \vec p_i \cdot \vec c$ and $a_i' = \vec p_i \cdot \vec c'$ so that

  \begin{align*}
    f(c) &= (p_i(c))_{i \in I} = (\vec p_i \cdot \vec c)_{i \in I} = (a_i)_{i \in I} \\
    f(c') &= (p_i(c'))_{i \in I} = (\vec p_i \cdot \vec c')_{i \in I} = (a_i')_{i \in I}
  \end{align*}

  For each $i$ we show that $a_i, a_i'$ are in the same sub-interval and have the same interval type, so the conclusion follows by Lemma \ref{main_lemma}
  ($f(c_1), f(c_2)$ are in the same partition ensuring the proper order of T-valuations for the 3rd condition of the lemma).
  $\It$ records the interval type of each element, so if $g(\bar a) = g(\bar a')$ then $a_i, a_i'$ have the same interval type for all $i \in I$.
  Thus it remains to show that $a_i, a_i'$ lie in the same sub-interval for all $i \in I$.
  Suppose $i$ is an independent index.
  Then by construction, $\Sub$ records the sub-interval for $a_i, a_i'$, so those have to belong to the same sub-interval.
  Now suppose $i$ is dependent.
  Pick the largest $j < i$ such that $j$ is independent.
  We have $F(a_i) \leq F(a_j)$ and $F(a_i') \leq F(a_j')$.
  Moreover $F(a_j) = F(a_j')$ as $a_j, a_j'$ lie in the same sub-interval (using the earlier part of the argument as $j$ is independent).
  
  \begin{Claim}
    $\val(a_i - a_i') \geq F(a_j) - \gamma$
  \end{Claim}
  \begin{proof}
    Let $K$ be the set of the independent indices less than $i$.
    Note that by the definition for dependent indices we have $\vec p_i \in \vecspan \curly{\vec p_k}_{k \in K}$.
    We also have 
    \begin{align*}
      \val(a_k - a_k') \geq F(a_k) \text { for all } k \in K
    \end{align*}
    as $a_k, a_k'$ lie in the same sub-interval (using the earlier part of the argument as $k$ is independent).
    \begin{align*}
      &\val(a_k - a_k') \geq F(a_j) \text { for all } k \in K \text{ by monotonicity of $F(a_k)$} \\
      &\val(\vec p_k \cdot \vec c - \vec p_k \cdot \vec c') \geq F(a_j) \text { for all } k \in K \\
      &\val(\vec p_k \cdot (\vec c - \vec c')) \geq F(a_j) \text { for all } k \in K \\
    \end{align*}
    $K \subset I, i \in I, \vec c - \vec c' \in \Q_p^{|x|}, F(a_j) \in \Z$
    satisfy the requirements of Lemma \ref {gamma}, so we apply it to conclude
    \begin{align*}
      &\val(\vec p_i \cdot (\vec c - \vec c')) \geq F(a_j) - \gamma \\
      &\val(\vec p_i \cdot \vec c - \vec p_i \cdot \vec c') \geq F(a_j) - \gamma \\
      &\val(a_i - a_i') \geq F(a_j) - \gamma
    \end{align*}
    as needed, finishing the proof of the claim.
  \end{proof}	
  Additionally $a_i, a_i'$ have the same image in $\Ct$ component, so we have
  \begin{align*}
    \val(a_i - a_i') > F(a_j) 
  \end{align*}
  As $F(a_i) \leq F(a_j)$, $a_i, a_i'$ have to lie in the same sub-interval.	
  TO DO: PROVE THE PREVIOUS SENTENCE FORMALLY
  Suppose that $a_i$ lies in the sub-interval $\paren{B(t_L, \alpha_L),  B(t_U, \alpha_U)}$
  and that $a_i'$ lies in the sub-interval $\paren{B(t_L', \alpha_L'),  B(t_U', \alpha_U')}$.
\end{proof}

\begin{Corollary}
  $\Phi(x,y)$ has VC-density $\leq |x|$.
\end{Corollary}

\begin{proof}
  Suppose we have $c, c' \in \Q_p^{|x|}$ such that $f(c), f(c')$ are in the same partition and $g(f(c)) = g(f(c'))$.
  Then by the previous lemma $c, c'$ have the same $\Phi$-type.
  Thus the number of possible $\Phi$-types is bounded by the size of the range of $g$ times the number of possible partitions
  
  \begin{align*}
    \text{(number of partitions)} \cdot |\It|^{|I|} \cdot |\Sub|^{|J|} \cdot |\Ct|^{|I-J|}
  \end{align*}

  There are at most $\paren{|2I|!}^2$ many partitions of $\Sg$,
  so in the product above, the only component dependent on $B$ is

  \begin{align*}
    |\Sub|^{|J|} \leq (N \cdot 3{|I|}^2)^{|J|} = O(N^{|J|})
  \end{align*}	
  
  Every $p_i$ is an element of a $|x|$-dimensional vector space, so there can be at most $|x|$ many independent vectors.
  Thus we have $|J| \leq |x|$ and the bound follows.
\end{proof}

\begin{Corollary} [Theorem \ref{main_theorem}]
  $(\Q_p, \LL_{aff})$ has $\vc(n) = n$.
\end{Corollary}

\begin{proof}
  Previous lemma implies that $\vc(\phi) \leq \vc(\Phi) \leq |x|$.
  As choice of $\phi$ was arbitrary, this implies that VC-density of any formula is bounded by the arity of $x$.
\end{proof}

This proof relies heavily on the linearity of functions $a_1, a_2, c$ in the cell deomposition result (see Definition \ref{cell}).
Linearity is used to separate $x$ and $y$ variables as well as
for Lemma \ref{gamma} to reduce the number of independent factors from $|I|$ to $|x|$.
The paper \cite{reduct} has cell decomposition results for more expressive reducts of $\Q_p$,
including, for exapmple, restricted multiplication.
While our results don't apply to it directly,
it is this author's hope that similar techniques can be used to compute $\vc(n)$ function for those structures.

\begin{thebibliography}{9}
\bibitem{density}
  M. Aschenbrenner, A. Dolich, D. Haskell, D. Macpherson, S. Starchenko,
  \textit{Vapnik-Chervonenkis density in some theories without the independence property}, I,
  Trans. Amer. Math. Soc. 368 (2016), 5889-5949
\bibitem{reduct}
  E. Leenknegt. \textit{Reducts of $p$-adically closed fields}, Archive for Mathematical logic, 53(3):285-306, 2014
\end{thebibliography}










\end{document}








