\documentclass{amsart}

\usepackage{../AMC_style}	
\usepackage{../Research}
\usepackage{../Thm}

\usepackage{enumitem}

\usepackage{mathrsfs}
\usepackage{pgfpages}
\usepackage{setspace}

\doublespacing
% \usepackage[margin=.75in]{geometry}
% \pgfpagesuselayout{2 on 1}

\renewcommand{\AA}{\mathscr A}
\newcommand{\BB}{\mathscr B}
\newcommand{\DD}{\mathscr D}
\newcommand{\II}{\mathscr I}
\newcommand{\MM}{\mathscr M}

\newcommand{\A}{\mathcal A}
\newcommand{\B}{\mathcal B} 
\renewcommand{\C}{\mathcal C}
\newcommand{\D}{\mathcal D}
\newcommand{\F}{\mathcal F}
\newcommand{\G}{\mathcal G}
\renewcommand{\H}{\mathcal H}
\renewcommand{\LL}{\mathcal L}
\newcommand{\LLA}{\mathcal L_{aff}}
\newcommand{\LLM}{\mathcal L_{Mac}}
\newcommand{\M}{\mathcal M}

\newcommand{\U}{\mathcal U}	


\newcommand{\curly}[1]{\left\{#1\right\}}
\newcommand{\paren}[1]{\left(#1\right)}
\newcommand{\abs}[1]{\left|#1\right|}

\providecommand{\floor}[1]{\left \lfloor #1 \right \rfloor }

\DeclareMathOperator{\Sg}{Sg}
\DeclareMathOperator{\It}{Tp}
\DeclareMathOperator{\Sub}{Sub}
\DeclareMathOperator{\Ct}{Ct}
\DeclareMathOperator{\vecspan}{span}
\DeclareMathOperator{\val}{val}
\DeclareMathOperator{\vval}{val}
\DeclareMathOperator{\tval}{T-val}
\DeclareMathOperator{\inti}{I}

\newcommand{\defn}{\underline}
\newcommand{\interval}{\inti(t, \alpha_L, \alpha_U)}



\title{vc-density in an additive reduct of the $P$-adic numbers}
\author{Anton Bobkov}
\email{bobkov@math.ucla.edu}

\begin{document}

\begin{abstract}
  Aschenbrenner et. al. computed a bound $\vc(n) \leq 2n - 1$ for the vc-density function in the field of $p$-adic numbers,
  but it is not known to be optimal.
  In this paper we investigate a certain $P$-minimal additive reduct of the field of $p$-adic numbers and
  use a cell decomposition result of Leenknegt to compute an optimal bound $\vc(n) = n$ for that structure.
\end{abstract}


\maketitle

VC-density was studied in model theory in \cite{density} by Aschenbrenner, Dolich, Haskell, MacPherson, and Starchenko
as a natural notion of dimension for definable families of sets in NIP theories.
In a complete NIP theory $T$ we can define the vc-function

\begin{align*}
  \vc^T = \vc : \N \arr \N
\end{align*}

where $\vc(n)$ measures the worst-case complexity of families of definable sets in an $n$-fold cartesian power of the underlying set of a model of $T$
(see \ref{vc_fn_def} below for a precise definition of $vc^T$).
The simplest possible behavior is $\vc(n) = n$ for all $n$,
satisfied, for example, if $T$ is o-minimal.
For $T = \Th(\Q_p)$, the paper \cite{density} computes an upper bound for this function to be $2n-1$, and it is not known whether this is optimal.
This same bound holds in any reduct of the field of $p$-adic numbers, but one may expect that the simplified structure of the reduct would allow a better bound.
In \cite{reduct}, Leenknegt provides a cell decomposition result for a certain $P$-minimal additive reduct of the field of $p$-adic numbers.
Using this result, in this paper we improve the bound for the vc-function, showing that in Leenknegt's structure $\vc(n) = n$.

Section 1 defines vc-density and states some basic lemmas about it.
A more in depth exposition of vc-density can be found in \cite{density}.
Section 2 defines and states some basic facts about the theory of $p$-adic numbers.
Here we also introduce the reduct which we will be working with.
Section 3 sets up basic definitions and lemmas that will be needed for the proof.
We define trees and intervals and show how they help with vc-density calculations.
Section 4 concludes the proof.

Throughout the paper, variables and tuples of elements will be simply denoted as $x, y, a, b, \ldots$.
We will occasionally write $\vec a$ instead of $a$ for a tuple in $\Q_p^n$ to emphasize it as an element of $\Q_p$-vector space $\Q_p^n$.
We denote the arity of a tuple $x$ of variables by $|x|$.
% First-order formulas will have parameter variables separated $\phi(x; y)$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

\section{VC-dimension and vc-density}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 



  Throughout this section we work with a collection $\F$ of subsets of a set $X$.
  We call the pair $(X, \F)$ a \defn{set system}.

\begin{Definition}
  \begin{itemize}
  \item Given a subset $A$ of $X$, we define the set system $(A, A \cap \F)$
    where $A \cap \F = \curly{A \cap F \mid F\in \F}$.
  \item For $A \subset X$ we say that $\F$ \defn{shatters} $A$ if $A \cap \F = \PP(A)$ (the power set of $A$).
  \end{itemize}    
\end{Definition}  

\begin{Definition}
  We say $(X, \F)$ has \defn{VC-dimension} $n$ if the largest subset of $X$ shattered by $\F$ is of size $n$.
  If $\F$ shatters arbitrarily large subsets of $X$, we say that $(X, \F)$ has infinite VC-dimension.
  We denote the VC-dimension of $(X, \F)$ by $\VC(X, \F)$.
\end{Definition}  

\begin{Note}
  We may drop $X$ from the $\VC(X, \F)$, as the VC-dimension doesn't depend on the base set and is determined by $(\bigcup \F, \F)$.
\end{Note}
Set systems of finite VC-dimension tend to have good combinatorial properties,
and we consider set systems with infinite VC-dimension to be poorly behaved.

Another natural combinatorial notion is that of a dual system:
\begin{Definition}
  For $a \in X$ define $X_a = \curly{F \in \F \mid a \in F}$.
  Let $\F^* = \curly{X_a \mid a \in X}$.
  We call $(\F, \F^*)$ the \defn{dual system} of $(X, \F)$.
  The VC-dimension of the dual system of $(X, \F)$ is referred to as the \defn{dual VC-dimension} of $(X, \F)$ and denoted by $\VC^*(\F)$.
  (As before, this notion doesn't depend on $X$.)
\end{Definition}  

\begin{Lemma}
  A set system $(X, \F)$ has finite VC-dimension if and only if its dual system has finite VC-dimension.
  More precisely
  \begin{align*}
    \VC^*(\F) \leq 2^{1+\VC(\F)}.
  \end{align*}
\end{Lemma}

For a more refined notion of complexity of $(X, \F)$ we look at the traces of our family on finite sets:
\begin{Definition}
  Define the \defn{shatter function} $\pi_\F \colon \N \arr \N$ and the \defn{dual shatter function} $\pi^*_\F \colon \N \arr \N$ of $\F$ by 
  \begin{align*}
    \pi_\F(n) &= \max \curly{|A \cap \F| \mid A \subset X \text{ and } |A| = n} \\
	  \pi^*_\F(n) &= \max \curly{\text{atoms($B$)} \mid B \subset \F, |B| = n}
  \end{align*}
    where atoms($B$) = number of atoms in the Boolean algebra of sets generated by $B$.
  Note that the dual shatter function is precisely the shatter function of the dual system: $\pi^*_\F = \pi_{\F^*}$.
\end{Definition}  

A simple upper bound is $\pi_\F(n) \leq 2^n$ (same for the dual).
If the VC-dimension of $\F$ is infinite then clearly $\pi_\F(n) = 2^n$ for all $n$. Conversely we have the following remarkable fact:
\begin{Theorem} [Sauer-Shelah '72]
  If the set system $(X, \F)$ has finite VC-dimension $d$ then $\pi_\F(n) \leq {n \choose \leq d}$ for all $n$, where
  ${n \choose \leq d} = {n \choose d} + {n \choose d - 1} + \ldots + {n \choose 1}$.    
\end{Theorem}

Thus the systems with a finite VC-dimension are precisely the systems where the shatter function grows polynomially.
Define the vc-density of $\F$ to quantify the growth of the shatter function of $\F$: 
\begin{Definition}
  Define \defn{vc-density} and \defn{dual vc-density} of $\F$ as
  \begin{align*}
    \vc(\F) &= \limsup_{n \to \infty}\frac{\log \pi_\F(n)}{\log n} \in \R^{\geq 0} \cup \curly{+\infty},\\
    \vc^*(\F) &= \limsup_{n \to \infty}\frac{\log \pi^*_\F(n)}{\log n}\in \R^{\geq 0} \cup \curly{+\infty}.
  \end{align*}
\end{Definition}

Generally speaking a shatter function that is bounded by a polynomial doesn't itself have to be a polynomial.
Proposition 4.12 in \cite{density} gives an example of a shatter function that grows like $n \log n$ (so it has vc-density $1$).

So far the notions that we have defined are purely combinatorial.
We now adapt VC-dimension and vc-density to the model theoretic context.

\begin{Definition}
  Work in a first-order structure $M$.
  Fix a finite collection of formulas $\Phi(x, y)$.

  \begin{itemize}
  \item For $\phi(x, y) \in \LL(M)$ and $b \in M^{|y|}$ let 
  \begin{align*}
	  \phi(M^{|x|}, b) = \{a \in M^{|x|} \mid \phi(a, b)\} \subseteq M^{|x|}.
  \end{align*}
  \item Let $\Phi(M^{|x|}, M^{|y|})= \{\phi(M^{|x|}, b) \mid \phi_i \in \Phi, b \in M^{|y|}\} \subseteq \PP(M^{|x|})$.
  \item Let $\F_\Phi = \Phi(M^{|x|}, M^{|y|})$, giving rise to a set system $(M^{|x|}, \F_\Phi)$.
  \item Define the \defn{VC-dimension} of $\Phi$, $\VC(\Phi)$ to be the VC-dimension of $(M^{|x|}, \F_\Phi)$, similarly for the dual.
  \item Define the \defn{vc-density} of $\Phi$, $\vc(\Phi)$ to be the vc-density of $(M^{|x|}, \F_\Phi)$, similarly for the dual.
  \end{itemize}

  We will also refer to the vc-density and VC-dimension of a single formula $\phi$
  viewing it as a one element collection $\Phi = \curly{\phi}$.
\end{Definition}

Counting atoms of a Boolean algebra in a model theoretic setting corresponds to counting types,
so it is instructive to rewrite the shatter function in terms of types.

\begin{Definition} 
  \begin{align*}
    \pi^*_\Phi(n) &= \max \curly{\text{number of $\Phi$-types over $B$} \mid B \subset M, |B| = n}
  \end{align*}
  Here a $\Phi$-type over $B$ is a maximal consistent collection of functions of the form $\phi(x, b)$ or $\neg\phi(x, b)$
  where $\phi \in \Phi$ and $b \in B$.
\end{Definition}  

\begin{Lemma} \label{count_types}
  \begin{align*}
    \vc^*(\Phi) &= \text{degree of polynomial growth of $\pi^*_\Phi(n)$}  = \limsup_{n \to \infty}\frac{\log \pi^*_\Phi(n)}{\log n}
  \end{align*}  
\end{Lemma}

\begin{proof}
  \begin{align*}
    &\pi^*_{\F_\Phi}\paren{n} \leq \pi^*_\Phi(n) \leq \pi^*_{\F_\Phi}\paren{|\Phi|n} \\
    &\vc^*(\Phi) \leq \limsup_{n \to \infty}\frac{\log \pi^*_\Phi(n)}{\log n} \leq \limsup_{n \to \infty}\frac{\log \pi^*_{\F_\Phi}\paren{|\Phi|n}}{\log n} = \\
    & = \limsup_{n \to \infty}\frac{\log \pi^*_{\F_\Phi}\paren{|\Phi|n}}{\log |\Phi|n} \frac{\log |\Phi|n}{\log n} =
      \limsup_{n \to \infty}\frac{\log \pi^*_{\F_\Phi}\paren{|\Phi|n}}{\log |\Phi|n} \leq \\
    &\leq \limsup_{n \to \infty}\frac{\log \pi^*_{\F_\Phi}\paren{n}}{\log n} = \vc^*(\Phi)
  \end{align*}
\end{proof} 

One can check that the shatter function and hence VC-dimension and vc-density of a formula are elementary notions,
so they only depend on the first-order theory of the structure.

NIP theories are a natural context for studying vc-density.
In fact we can take the following as the definition of NIP:
\begin{Definition}
  Define $\phi$ to be NIP if it has finite VC-dimension.
  A theory $T$ is NIP if all the formulas are NIP.
\end{Definition}

% \cite{Aschenbrenner_reference_8} shows that in a
% \item general combinatorial context,
In a general combinatorial context for arbitrary set systems,
vc-density can be any real number in $0 \cup [1, \infty)$.
Less is known if we restrict our attention to NIP theories.
Proposition 4.6 in \cite{density} gives examples of formulas that have non-integer rational vc-density in an NIP theory,
however it is open whether one can get an irrational vc-density in this model-theoretic setting.

Instead of working with a theory formula by formula, we can look for a uniform bound for all formulas:
\begin{Definition} \label{vc_fn_def}
  For a given NIP structure $M$, define the \defn{vc-function}
  \begin{align*}
    \vc^M(n) &= \sup \{\vc^*(\phi(x, y)) \mid \phi \in \LL(M), |x| = n\} \\
             &= \sup \{\vc(\phi(x, y)) \mid \phi \in \LL(M), |y| = n\}
  \end{align*}
\end{Definition}

As before this definition is elementary, so it only depends on the theory of $M$.
We omit the superscript $M$ if it is understood from the context.
One can easily check the following bounds:
\begin{Lemma} [Lemma 3.22 in \cite{density}] We have $\vc(1) \geq 1$ and $\vc(n) \geq n\vc(1)$.
  
\end{Lemma}

However, it is not known whether the second inequality can be strict or even whether $\vc(1) < \infty$ implies $\vc(n) < \infty$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

\section{$P$-adic numbers}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

The field $\Q_p$ of $p$-adic numbers is often studied in the language of Macintyre 
  \begin{align*}
	\LLM = \curly{0, 1, +, -, \cdot, |, \{P_n\}_{n \in \N}}
  \end{align*}
which is a language $\curly{0, 1, +, -, \cdot}$ of fields together with unary predicates $P_n$ interpreted in $\Q_p$ so as to satisfy

\begin{align*}
  P_n x \leftrightarrow \exists y \; y^n = x
\end{align*}

and a divisibility relation where $a|b$ holds in $\Q_p$ when $\vval a \leq \vval b$.

Note that $P_n\backslash \curly{0}$ is a multiplicative subgroup of $\Q_p$ with finitely many cosets.

\begin{Theorem} [Macintyre '76]
  The $\LLM$-structure $\Q_p$ has quantifier elimination.
\end{Theorem}

There is also a cell decomposition result:
\begin{Definition}
  Define \defn{$k$-cell} recursively as follows.
  $0$-cell is a singleton subset of $\Q_p$.
  A $(k+1)$-cell is a subset of $\Q_p^{k+1}$ of the following form:
  \begin{align*}
    \curly{(x, t) \in D \times \Q_p \mid \vval a_1(x) \ \square_1 \vval (t - c(x)) \ \square_2 \vval a_2(x), t - c(x) \in \lambda P_n}
  \end{align*}
  where $D$ is a $k$-cell,
  $a_1(x), a_2(x), c(x)$ are definable functions $D \arr \Q_p$,
  $\square_i$ is $<, \leq$ or no condition, and
  $\lambda \in \Q_p$.    
\end{Definition}

\begin{Theorem} [Denef '84]
  Any definable subset of $Q_p^n$ defined by an $\LLM$-formula decomposes into a finite disjoint union of $n$-cells.
\end{Theorem}  

In \cite{density}, Aschenbrenner, Dolich, Haskell, Macpherson, and Starchenko show that this structure satisfies $\vc(n) \leq 2n - 1$,
however it is not known whether this bound is optimal.

In \cite{reduct}, Leenknegt analyzes the reduct of $\Q_p$ to the language
\begin{align*}
  \LL_{aff}  = \curly{0, 1, +, -, \curly{\bar c}_{c \in \Q_p}, |, \curly{Q_{m,n}}_{m,n\in \N}}
\end{align*}
where $\bar c$ denotes a scalar multiplication by $c$,
$a | b$ as above stands for $\vval a \leq \vval b$,
and $Q_{m,n}$ is a unary predicate interpreted as
\begin{align*}
  Q_{m,n} = \bigcup_{k \in \Z} p^{km} (1 + p^n\Z_p).
\end{align*}
Note that $Q_{m,n} \backslash \curly{0}$ is a subgroup of the multiplicative group of $\Q_p$ with finitely many cosets.
One can check that these extra relation symbols are definable in the $\LLM$-structure $\Q_p$.
The paper \cite{reduct} provides a cell decomposition result with the following cells:

\begin{Definition} \label{cell}
  A $0$-cell is a singleton subset of $\Q_p$.
  A $(k+1)$-cell is a subset of $\Q_p^{k+1}$ of the following form:
  \begin{align*}
    \curly{(x, t) \in D \times \Q_p \mid \vval a_1(x) \ \square_1 \vval (t - c(x)) \ \square_2 \vval a_2(x), t - c(x) \in \lambda Q_{m,n} }
  \end{align*}
  where $D$ is a $k$-cell, called the \defn{base} of the cell,
  $a_1(x), a_2(x), c(x)$ are polynomials of degree $\leq 1$, called the \defn{defining polynomials}
  $\square_1, \square_2$ is $<$ or no condition, and
  $\lambda  \in\Q_p$.
  We call $\Q_{m,n}$ the \defn{defining predicate}.
\end{Definition}

\begin{Theorem}[Leenknegt '12] 
  Any definable subset of $Q_p^n$ defined by an $\LL_{aff}$-formula decomposes into a finite disjoint union of $n$-cells.
  %Any formula $\phi(x, t)$ in $(\Q_p, \LL_{aff})$ with $|x| = n$ and $|t| = 1$ decomposes into a union of $(k+1)$-cells.
\end{Theorem}  

Moreover, \cite{reduct} shows that $(\Q_p, \LL_{aff})$ is a $P$-minimal reduct,
that is, the one-dimensional definable sets of $(\Q_p, \LL_{aff})$ coincide with the one-dimensional definable sets in the full structure $(\Q_p, \LLM)$.

The main result of this paper is the computation of the $\vc$-function for this structure:
\begin{Theorem} \label{main_theorem}
  $(\Q_p, \LL_{aff})$ has $\vc(n) = n$.
\end{Theorem}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

\section{Key Lemmas and Definitions}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 



To show that $\vc(n) = n$ it suffices to bound $\vc^*(\phi) \leq |x|$ for every $\LL_{aff}$-formula $\phi(x; y)$.
Fix such a formula $\phi(x; y)$.
Instead of working with it directly, we simplify it using quantifier elimination.
The required quantifier elimination result can be easily obtained from cell decomposition:
\begin{Lemma} \label {quantifier_elimination}
  Any formula $\phi(x; y)$ in $(\Q_p, \LL_{aff})$ can be written as a boolean combination of formulas from the following collection
  \begin{align*}
    \Phi(x; y) = &\curly{\vval (p_i(x) - c_i(y)) < \vval (p_j(x) - c_j(y))}_{i, j \in I} \cup \\
                 &\curly{p_i(x) - c_i(y) \in \lambda_k Q_{m,n}}_{i \in I , k \in K}
  \end{align*}
  where $I, K$ are finite index sets,
  each $p_i$ is a degree $\leq 1$ polynomial in $x$ without a constant term,
  each $c_i$ is a degree $\leq 1$ polynomial in $y$, and
  $\lambda_k \in \Q_p$.
\end{Lemma}

\begin{proof}
  Let $l = |x| + |y|$.
  Partition the subset of $\Q_p^l$ defined by $\phi$ to obtain $\DD^l$, a collection of $l$-cells.
  Let $\DD^{l-1}$ be the collection of the bases of the cells in $\DD^l$.
  Similarly, construct by induction $\DD^i$ for each $0 \leq j < l$,
  where $\DD^j$ is the collection of $j$-cells which are the bases of cells in $\DD^{j+1}$.
  % Let $\DD = \bigcup \DD_j$.
  \begin{align*}
    &m = \prod \curly{m' \mid Q_{m',n'} \text{ is the defining predicate of a cell in $\DD^j$ for $0 \leq j \leq l$} } \\
    &n = \max \curly{n' \mid Q_{m',n'} \text{ is the defining predicate of a cell in $\DD^j$ for $0 \leq j \leq l$} }
  \end{align*}
  % Choose $m,n$ large enough to cover all $m', n'$ for $Q_{m',n'}$ that show up in the cells of $\DD$.
  This way if $a, a'$ are in the same coset of $Q_{m',n'}$ then they are in the same coset of $Q_{m,n}$.
  Choose $\curly{\lambda_k}_{k \in K}$ to go over all the cosets of $Q_{m,n}$.
  Let $q_i(x, y)$ enumerate all of the defining polynomials $a_1(x), a_2(x), t - c(x)$ that show up in the cells of $\DD^j$ for any $j$.
  All if those are all polynomials of degree $\leq 1$ in variables $x, y$.
  We can split each of them as $q_i(x,y) = p_i(x) - c_i(y)$ where the constant term goes into $c_i$.
  This gives us the appropriate finite collection of formulas $\Phi$.
  From the cell decomposition it is easy to see that when $a, a'$ have the same $\Phi$-type,
  then they have the same $\phi$-type.
  Thus $\phi$ can be written as a boolean combination of formulas from $\Phi$.
\end{proof}

\begin{Lemma}
  Let $\Phi(x; y)$ be a finite collection of formulas.
  If $\phi$ can be written as a boolean combination of formulas from $\Phi$ then
  \begin{align*}
    \vc^* (\Phi) \leq r \implies \vc^* (\phi) \leq r \; \text{ for all } r \in \R
  \end{align*}
\end{Lemma}
\begin{proof}
  If $a,a'$ have the same $\Phi$-type over $B$, then they have the same $\phi$-type over $B$, where $B$ is some parameter set.
  Therefore the number of $\phi$-types is bounded by the number of $\Phi$-types.
  The bound follows from Lemma \ref{count_types}.
\end{proof}

For the remainder of the paper fix $\Phi(x; y)$ to be the collection of formulas defined by Lemma \ref{quantifier_elimination}.
By the previous lemma, to show that $\vc^*(\phi) \leq |x|$, it suffices to bound $\vc^*(\Phi) \leq |x|$.
More precisely, it is sufficient to show that if there is a parameter set $B$ of size $N$
then the number of $\Phi$-types over $B$ is $O(N^{|x|})$.
Fix such a parameter set $B$ and work with it from now on.
We will compute a bound for the number of $\Phi$-types over $B$.

Consider a set $T = T(\Phi, B) = \curly{c_i(b) \mid b \in B, i \in I} \subset \Q_p$.
In this definition $B$ is the parameter set that we have fixed 
and $c_i(b)$ come from the collection of formulas $\Phi$ from the quantifier elimination above.
View $T$ as a tree as follows:
\begin{Definition} \ 
  \begin{itemize}
  \item For $c \in \Q_p, \alpha \in \Z$  define a \defn{ball} 
    \begin{align*}
      B(c, \alpha) = \curly{c' \in \Q_p \mid \vval \paren{c' - c} > \alpha}.  
    \end{align*}
    We also let $B(c, -\infty) = \Q_p$ and $B(c, +\infty) = \emptyset$.
  \item Define a collection of balls $\BB = \curly{B(t_1, \vval(t_1 - t_2))}_{t_1, t_2 \in T}$.
    Note that $\BB$ is a (directed) boolean algebra of sets in $\Q_p$.
    We refer to the atoms in that algebra as \defn{intervals}.
    Note that the intervals partition $\Q_p$ so any element $a \in \Q_p$ belongs to a unique interval.
  \item Let's introduce some notation for the intervals.
    For $t \in T$ and $\alpha_L, \alpha_U \in \Z \cup \curly{-\infty, +\infty}$ define
    \begin{align*}
      \interval = B(t, \alpha_L) \backslash \bigcup \curly{B(t', \alpha_U) \mid t' \in T, \vval(t' - t) \geq \alpha_U}
    \end{align*}
    (this is sometimes referred to as the swiss cheese construction).
    One can check that every interval is of the form $\interval$ for some values of $t, \alpha_L, \alpha_U$.
    Quantities $\alpha_L, \alpha_U$ are uniquely determined by the interval,
    while $t$ might not be.
  \item Intervals are a natural construction for trees, however we will require a more refined notion to make Lemma \ref{main_lemma} below work.
    Define a larger collection of balls 
    \begin{align*}
      \BB' = \BB \cup \curly{B(c_i(b), \vval(c_j(b) - c_k(b)))}_{i,j,k \in I, b \in B}.  
    \end{align*}
    Similar to the previous definition, we define a \defn{subinterval} to be an atom of the boolean algebra generated by $\BB'$.
    Subintervals refine intervals.
    Moreover, as before, each subinterval can be written as $\interval$ for some values of $t, \alpha_L, \alpha_U$.
    As before, $\alpha_L, \alpha_U$ are uniquely determined by the subinterval,
    while $t$ might not be.
  \end{itemize}
\end{Definition}

Subintervals are fine enough to make Lemma \ref{main_lemma} below work while coarse enough to be $O(N)$ small:
\begin{Lemma} \label{interval_count}\ 
  \begin{itemize}
  \item 
    There are at most $2|T| = 2 N |I| = O(N)$ different intervals.
  \item 
    There are at most $2|T| + |B| \cdot |I|^3 = O(N)$ different subintervals.
  \end{itemize}
\end{Lemma}

\begin{proof}
  Each new element in the tree $T$ adds at most two intervals to the total count,
  so by induction there can be at most $2|T|$ many intervals.
  Each new ball in $\BB' \backslash \BB$ adds at most one subinterval to the total count,
  so by induction there are at most $|\BB' \backslash \BB|$ more subintervals than there are intervals.
\end{proof}


\begin{Definition}
  Suppose $a \in \Q_p$ lies in an interval $\interval$. 
  Define the \defn{T-valuation} of $a$ to be $\tval(a) = \vval(a - t)$.    
\end{Definition}

This a natural notion having the following properties:
\begin{Lemma}  \label{tval} \ 
  \begin{enumerate}[label=(\alph*)]
  \item $\tval(a)$ is well-defined, independent of choice of $t$ to represent the interval.
  \item If $a \in \Q_p$ lies in a subinterval $\interval$,
    then $\tval(a) = \vval(a - t)$.
  \item If $a \in \Q_p$ lies in a (sub)interval $\interval$ 
    then $\alpha_L < \tval(a) \leq \alpha_U$.
  \item For any $a \in \Q_p$ lying in a (sub)interval $\interval$ and $t' \in T$
    \begin{itemize}
    \item If $\vval(t - t') \geq \alpha_U$, then $\vval(a - t') = \tval(a)$. 
    \item If $\vval(t - t') \leq \alpha_L$, then $\vval(a - t') = \vval(t - t') \paren{\leq \alpha_L < \tval(a)}$. 
    \end{itemize}
  \end{enumerate}
\end{Lemma}


\begin{proof}
  (a)-(c) are clear.
  For (d) fix $t' \in T$ and suppose $a \in \Q_p$ lies in a subinterval $\inti(t, \alpha_L', \alpha_U')$.
  This  subinterval lies inside of an interval $\interval$ for some choice of $\alpha_L, \alpha_U$ and
  by the definition of intervals (or more specifically $\BB$)
  \begin{align*}
    \vval(t - t') \geq \alpha_U &\iff \vval(t - t') \geq \alpha_U'\\
    \vval(t - t') \geq \alpha_L &\iff \vval(t - t') \geq \alpha_L'.
  \end{align*}
  Therefore without loss of generality we may assume that $a \in \Q_p$ lies in an interval $\interval$.
  By (c) and the definition of intervals one of the three following cases has to hold.
  
  Case 1: $\vval(t - t') \geq \alpha_U$ and $\tval(a) < \alpha_U$. Then
  \begin{align*}
    \vval(t - t') \geq \alpha_U > \tval(a) = \vval(a - t),
  \end{align*}
  thus $\vval(a - t') = \vval(a - t) = \tval(a)$ as needed.

  Case 2: $\vval(t - t') \geq \alpha_U$ and $\tval(a) = \alpha_U$. Then
  \begin{align*}
    \tval(a) = \vval(a - t) = \vval(t - t') \geq \alpha_U,
  \end{align*}
  thus $\vval(a - t') \geq \alpha_U$.
  The interval $\interval$ is disjoint from the ball $B(t', \alpha_U)$,
  so $a \notin B(t', \alpha_U)$, that is, $\val(a - t') \leq \alpha_U$.
  Combining this with the previous inequality we get that $\val(a - t') = \alpha_U = \tval(a)$ as needed.

  Case 3: $\vval(t - t') \leq \alpha_L$. Then
  \begin{align*}
    \vval(t - t') \leq \alpha_L < \tval(a) = \vval(a - t),
  \end{align*}
  thus $\vval(a - t') = \vval(t - t')$ as needed. 
\end{proof}




\begin{Definition}
  Suppose $a \in \Q_p$ lies in a subinterval $\interval$.
  We say that $a$ is \defn{far from the boundary} (of $\interval$) if 
    \begin{align*}
	\alpha_L + n \leq \tval(a) \leq \alpha_U - n.
    \end{align*}
  Here $n$ is from the Lemma \cite{quantifier_elimination}.
  Otherwise we say that it is \defn{close to the boundary}.
\end{Definition}

\begin{Definition}
  Suppose $a_1, a_2 \in \Q_p$ lie in the same subinterval $\interval$.
  We say $a_1, a_2$ have the same \defn{subinterval type} if one of the following holds:
  \begin{itemize}
  \item Both $a_1, a_2$ are far from the boundary and $a_1 - t, a_2 - t$ are in the same $Q_{m,n}$ coset.
    ($Q_{m,n}$ is from the Lemma \cite{quantifier_elimination}.)
  \item Both $a_1, a_2$ are close to the boundary and 
    \begin{align*}
	  \tval(a_1) = \tval(a_2) \leq \vval(a_1 - a_2) - n.
    \end{align*}
  \end{itemize}      
\end{Definition}


\begin{Definition}
	For $c \in \Q_p$ and $\alpha, \beta \in \Z$ define $c \midr [\alpha, \beta) \in \paren{\Z/p\Z}^{\beta - \alpha}$
  to be the record of the coefficients of $c$ for the valuations between $[\alpha, \beta)$.
  More precisely write $c$ in its power series form
  \begin{align*}
    c = \sum_{\gamma \in \Z} c_\gamma p^\gamma \text{ with } c_\gamma \in \Z/p\Z
  \end{align*}
  Then $c \midr [\alpha, \beta)$ is just $(c_\alpha, c_{\alpha+1}, \ldots c_{\beta - 1})$.
\end{Definition}

The following lemma is an adaptation of Lemma 7.4 in \cite{density}.
\begin{Lemma} \label{distance}
  Fix $m,n \in \N$.
  For any $x,y,c \in \Q_p$, if
  \begin{align*}
    \val (x - c) = \val (y - c) \leq \val (x - y) - n,
  \end{align*}
  then $x - c, y - c$ are in the same coset of $Q_{m,n}$.
\end{Lemma}
\begin{proof}
  Call $a,b \in \Q_p$ similar if $\val a = \val b$ and
  \begin{align*}
    a \midr [\val a, \val a + n) = b \midr [\val b, \val b + n)
  \end{align*}
  If $a,b$ are similar then
  \begin{align*}
    a \in Q_{m,n} \iff b \in Q_{m,n}
  \end{align*}
  Moreover for any $\lambda \in \Q_p^\times$, if $a,b$ are similar then so are $\lambda a, \lambda b$.
  Thus if $a,b$ are similar, then they belong to the same coset of $Q_{m,n}$.
  Conditions of the lemma force $x - c, y - c$ to be similar, thus belonging to the same coset.
\end{proof} 


\begin{Lemma} \label{interval_type_count}
  For each subinterval there are at most $K = K(Q_{m,n})$ many subinterval types 
  (with $K$ not dependent on $B$ on the subinterval).  
\end{Lemma}

\begin{proof}
  Let $a, a' \in \Q_p$ lie in the same subinterval $\interval$.

  Suppose $a, a'$ are far from the boundary.
  Then they have the same subinterval type if $a - t, a' - t$ are in the same $Q_{m,n}$-coset.
  Number of such subinterval types is bounded by the number of $Q_{m,n}$-cosets.

  Suppose $a, a'$ are close to the boundary and
  \begin{align*}
    &\tval(a) - \alpha_L = \tval(a') - \alpha_L < n \\
    &a \midr [\tval(a), \tval(a) + n) = a' \midr [\tval(a'), \tval(a') + n)  
  \end{align*}
  Then $a, a'$ have the same subinterval type.
  Such subinterval type is thus determined by $\tval(a) - \alpha_L$ and $a \midr [\tval(a), \tval(a) + n)$,
  therefore there are at most $n p^n$ many such types.

  A similar argument works for $a$ with $\alpha_U - \tval(a) \leq n$.

  Adding those up we get that there are at most
  \begin{align*}
    K = \text{(number of $Q_{m,n}$ cosets)} + 2 n p^n  
  \end{align*}
  many subinterval types.
\end{proof}

The following lemma relates tree notions to $\Phi$-types.
\begin{Lemma} \label{main_lemma}
  Suppose $d, d' \in \Q_p^{|x|}$ satisfy the follwing three conditions 
  \begin{itemize}
  \item For all $i \in I$ $p_i(d)$ and $p_i(d')$ are in the same subinterval.
  \item For all $i \in I$ $p_i(d)$ and $p_i(d')$ have the same subinterval type.
  \item For all $i,j \in I$, $\tval(p_i(d)) > \tval(p_j(d))$ iff $\tval(p_i(d')) > \tval(p_j(d'))$.
  \end{itemize}
  Then $d, d'$ have the same $\Phi$-type over $B$.
\end{Lemma}
\begin{proof}
  There are two kinds of formulas in $\Phi$
  (see Lemma \ref{quantifier_elimination}).
  First we show that $d, d'$ agree on formulas of the form $p_i(x) - c_i(y) \in \lambda_k Q_{m,n}$.
  It is enough to show that for every $i \in I, b \in B$ we have $p_i(d) - c_i(b), p_i(d') - c_i(b)$ are in the same $Q_{m,n}$-coset.
  Fix such $i, b$.
  For brievety let $a = p_i(d), a' = p_i(d')$ and $Q = Q_{m,n}$.
  We want to show that $a - c_i(b), a' - c_i(b)$ are in the same $Q$-coset.
  
  Suppose $a, a'$ are close to the boundary.
  Then $\tval(a) = \tval(a') \leq \val(a - a') - n$.
  Using Lemma \ref{tval}d, we have
  \begin{align*}
    \val(a - c_i(b)) = \val(a' - c_i(b)) \leq \tval(a) \leq \val(a - a') - n
  \end{align*}
  Lemma \ref{distance} shows that $a - c_i(b), a' - c_i(b)$ are in the same $Q$-coset.
  
  Now, suppose both $a, a'$ are far from the boundary.
  Label their interval as $\interval$.
  Then we have 
  \begin{align*}
    \alpha_L + n \leq &\val (a - t) \leq \alpha_U - n \\
    \alpha_L + n \leq &\val (a' - t) \leq \alpha_U - n
  \end{align*}
  (as being far from the subinterval's boundary also makes $a,a'$ far from interval's boundary).
  We have either $\val(t - c_i(b)) \geq \alpha_U$ or $\val(t - c_i(b)) \leq \alpha_L$ (as otherwise it would contradict the definition of intervals, or more specifically $\BB$).
  
  Suppose it is the first case $\val(t - c_i(b)) \geq \alpha_U$.
  Then using Lemma \ref{tval}d
  \begin{align*}
    \val(a - c_i(b)) = \val(a - t) \leq \alpha_U - n \leq \val(t - c_i(b)) - n.
  \end{align*}
  So by Lemma \ref{distance} we have $a - c_i(b), a - t$ are in the same $Q$-coset.
  By a parallel argument we have $a' - c_i(b), a' - t$ are in the same $Q$-coset.
  As $a, a'$ have the same subinterval type, $a - t, a' - t$ are in the same $Q$-coset.
  Thus by transitivity we get that $a - c_i(b), a' - c_i(b)$ are in the same $Q$-coset.
  
  For the second case, suppose $\val(t - c_i(b)) \leq \alpha_L$.
  Then using Lemma \ref{tval}d
  \begin{align*}
    \val(a - c_i(b)) = \val(t - c_i(b)) \leq \alpha_L \leq \val(a - t) - n
  \end{align*}
  so by Lemma \ref{distance} we have $a - c_i(b), t - c_i(b)$ are in the same $Q$-coset.
  By a parallel argument we have $a' - c_i(b), t - c_i(b)$ are in the same $Q$-coset.
  Thus by transitivity we get that $a - c_i(b), a' - c_i(b)$ are in the same $Q$-coset.

  Next, we need to show that $d, d'$ agree on formulas of the form
  $\vval (p_i(x) - c_i(y)) < \vval (p_j(x) - c_j(y))$ 
  (again, referring to the presentation in Lemma \ref{quantifier_elimination}).
  Fix $i,j \in I, b \in B$.
  We would like to show the following equivalence: 

  \begin{equation} \label {eq:order_equation}
	  \vval (p_i(d) - c_i(b)) < \vval (p_j(d) - c_j(b))  	  \iff \vval (p_i(d') - c_i(b)) < \vval (p_j(d') - c_j(b))
  \end{equation}

  Suppose $p_i(d), p_i(d')$ are in the subinterval $\inti(t_i, \alpha_i, \beta_i)$ and 
  $p_j(d), p_j(d')$ are in the subinterval $\inti(t_j, \alpha_j, \beta_j)$.
  Lemma \ref{tval}d yields 4 following cases.

  Case 1:
  \begin{align*}
    &\vval (p_i(d) - c_i(b)) = \vval (p_i(d') - c_i(b)) = \vval(t_i - c_i(b)) \\
    &\vval (p_j(d) - c_j(b)) = \vval (p_j(d') - c_j(b)) = \vval(t_j - c_j(b))
  \end{align*}
  Then it is clear that the equivalence \eqref{eq:order_equation} holds.

  Case 2:
  \begin{align*}
    &\vval (p_i(d) - c_i(b)) = \tval(p_i(d)) \text{ and } \vval (p_i(d') - c_i(b)) = \tval(p_i(d')) \\
    &\vval (p_j(d) - c_j(b)) = \tval(p_j(d)) \text{ and } \vval (p_j(d') - c_j(b)) = \tval(p_j(d'))
  \end{align*}
  Then the equivalence \eqref{eq:order_equation} holds by the third condition of the lemma that order of T-valuations is preserved.

 Case 3:
  \begin{align*}
    &\vval (p_i(d) - c_i(b)) = \vval (p_i(d') - c_i(b)) = \vval(t_i - c_i(b)) \\
    &\vval (p_j(d) - c_j(b)) = \tval(p_j(d)) \text{ and } \vval (p_j(d') - c_j(b)) = \tval(p_j(d'))
  \end{align*}
  If $p_j(d), p_j(d')$ are close to the boundary,
  then $\tval(p_j(d)) = \tval(p_j(d'))$ and the equivalence \eqref{eq:order_equation} clearly holds.
  Suppose then that $p_j(d), p_j(d')$ are far from the boundary.
  \begin{align*}
    \alpha_j + n \leq &\tval(p_j(d)), \tval(p_j(d')) \leq \beta_j - n \\
    \alpha_j < &\tval(p_j(d)), \tval(p_j(d')) < \beta_j
  \end{align*}
  and $\vval(t_i - c_i(b))$ lies outside of the $(\alpha_j, \beta_j)$
  by the definition of subinterval (more specifically definition of $\BB'$).
  Therefore \eqref{eq:order_equation} has to hold.
  (Note that we always have $\tval(p_j(d)), \tval(p_j(d')) \in (\alpha_j, \beta_j]$ by Lemma \ref{tval}c, so 
  we only need the far from the boundary condition to avoid the edge case of equality to $\beta_j$.)

  Case 4:
  \begin{align*}
    &\vval (p_i(d) - c_i(b)) = \tval(p_i(d)) \text{ and } \vval (p_i(d') - c_i(b)) = \tval(p_i(d')) \\
    &\vval (p_j(d) - c_j(b)) = \vval (p_j(d') - c_j(b)) = \vval(t_j - c_j(b))
  \end{align*}
  Similar to case 3 (switching $i,j$).
\end{proof}



\begin{Note}
  This gives us an upper bound on the number of types - there are at most $|2I|!$ many choices for the order of $\tval$,
  $O(N)$ many choices for the subinterval for each $p_i$,
  and $K$ many choices for the subinterval type for each $p_i$,
  giving a total of $O(N^{|I|}) \cdot K^{|I|} \cdot |I|! = O(N^{|I|})$ many types.
  This implies $\vc^*(\Phi) \leq |I|$.
  The biggest contribution to this bound are the choices among the $O(N)$ many subintervals for each $p_i$ with $i \in I$.
  Are all of those choices realized?
  Intuitively there are $|x|$ many variables and $|I|$ many equations,
  so once we choose an subinterval for $|x|$ many $p_i$'s, the subinterval for the rest should be determined.
  This would give the required $\vc^*(\Phi) \leq |x|$ bound.
  The next section outlines this idea formally.
\end{Note}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

\section{Main Proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

Alternative way to write $p_i(c)$ is $\vec p_i \cdot \vec c$,
where $\vec p_i$ and $\vec c$ are vectors in $\Q_p^{|x|}$ (as $p_i(x)$ is linear).

\begin{Lemma}	 \label{gamma}
  Suppose we have a finite collection of vectors $\curly{\vec p_i}_{i \in I}$ with each $\vec p_i \in \Q_p^{|x|}$.
  Suppose $J \subset I$ and $i \in I$ satisfy
  \begin{align*}
    \vec p_i \in \vecspan \curly{\vec p_j}_{j \in J}, 
  \end{align*}
  and we have $\vec c \in \Q_p^{|x|}, \alpha \in \Z$ with
  \begin{align*}
    \val(\vec p_j \cdot \vec c) > \alpha \text{ for all } j \in J
  \end{align*}
  Then
  \begin{align*}
    \val(\vec p_i \cdot \vec c) > \alpha - \gamma
  \end{align*}
  for some $\gamma \in \N$.
  Moreover $\gamma$ can be chosen independently from $J, j, \vec c, \alpha$ depending only on $\curly{\vec p_i}_{i \in I}$.
\end{Lemma}

\begin{proof}
  Fix $i, J$ satisfying the conditions of the lemma.
  For some $c_j \in \Q_p$ for $j \in J$ we have
  \begin{align*}
    \vec p_i &= \sum_{j \in J} c_j \vec p_j,
  \end{align*}
  hence
  \begin{align*}
    \vec p_i \cdot \vec c &= \sum_{j \in J} c_j \vec p_j \cdot \vec c.
  \end{align*}
  We have
  \begin{align*}
    \val \paren{c_j \vec p_j \cdot \vec c} = \val \paren{c_j} + \val \paren{\vec p_j \cdot \vec c} > \val \paren{c_j} + \alpha.
  \end{align*}
  % Pick $\gamma = -\max \val \paren{c_i}$ or $0$ if all those values are positive.
  Let $\gamma = \max(0, -\max_{j \in J} \val \paren{c_j})$.
  % Let $\gamma = -\min(0, \max_{j \in J} \val \paren{c_j})$.
  % Let $\gamma = \max(0, \min -\val \paren{c_j})$.
  Then we have 
  \begin{align*}
    &\val \paren{c_j \vec p_j \cdot \vec c} > \alpha - \gamma \text{ for all $j \in J$}\\
    &\val \paren{\sum_{j \in J} c_j \vec p_j \cdot \vec c} > \alpha - \gamma \\
    &\val(\vec p_i \cdot \vec c) > \alpha - \gamma
  \end{align*}
  This shows that we can pick such $\gamma$ for a given choice of $i, J$, but independent from $\alpha, \vec c$.
  To get a choice independent from $i, J$, go over all such eligible choices 
  ($i$ ranges over $I$ and $J$ ranges over subsets of $I$),
  pick $\gamma$ for each, and then take the maximum of those values.
\end{proof}

Fix $\gamma$ according to Lemma \ref{gamma} corresponding to $\curly{\vec p_i}_{i \in I}$ given by our collection of formulas $\Phi$.
(The lemma above is a general result, but we only use it applied to the vectors given by $\Phi$.)

\begin{Definition}
  Suppose $a \in \Q_p$ lies in a subinterval $\paren{B(t_L, \alpha_L),  B(t_U, \alpha_U)}$.
  Define \defn{floor} of $a$ to be $F(a) = \alpha_L$.
\end{Definition}

\begin{Definition}
  Let $f: \Q_p^{|x|} \arr \Q_p^I$ with $f(c) = (p_i(c))_{i \in I}$.
  Define the segment space $\Sg$ to be the image of $f$.	
\end{Definition}

Given a tuple $(a_i)_{i\in I}$ in the segment space,
look at the corresponding floors $\curly{F(a_i)}_{i\in I}$ and T-valuations $\curly{\tval(a_i)}_{i\in I}$.
Partition the segment space by the order types of $\{F(a_i)\}_{i\in I}$ and $\curly{\tval(a_i)}_{i\in I}$ (as subsets of $\Z$).

Work in a fixed partition $\Sg'$.
After relabeling we may assume that
\begin{align*}
  F(a_1) \geq F(a_2) \geq \ldots 
\end{align*}

Consider the (relabeled) sequence of vectors $\vec p_1, \vec p_2, \ldots, \vec p_I$.
There is a unique subset $J \subset I$ such that all vectors with indices in $J$ are linearly independent,
and all vectors with indices outside of $J$ are a linear combination of preceding vectors.
For any index $i \in I$ we call it \defn{independent} if $i \in J$ and we call it \defn{dependent} otherwise.


\begin{Definition} \ 
  \begin{itemize}
  \item Denote $\Z/p\Z^\gamma$ as \defn{$\Ct$}.
    Note that $|\Ct| = p^\gamma$.
  \item Let \defn{$\It$} be the space of all subinterval types.
    By Lemma \ref{interval_type_count} $|\It| \leq K$.
  \item Let \defn{$\Sub$} be the space of all subintervals.
    By Lemma \ref{interval_count} $|\Sub| \leq 3 |I|^2 \cdot N = O(N)$.
  \end{itemize}
\end{Definition}

\begin{Definition}
  Now, we define the following function
  \begin{align*}
    g_{\Sg'}: \Sg' \arr \It^I \times \Sub^J \times \Ct^{I \backslash J}
  \end{align*}

  Let $a = (a_i)_{i\in I} \in \Sg'$.
  To define $g_{\Sg'}(a)$ we need to specify where it maps $a$ in each individual component of the product.

  For each $a_i$ record its subinterval type, giving the first component $\It^I$.

  For $a_j$ with $j \in J$, record the subinterval of $a_j$, giving the second component $\Sub^J$.

  For the third component $\Ct^{I \backslash J}$ do the following computation.
  Pick $a_i$ with $i$ dependent.
  Let $j$ be the largest independent index with $j < i$.
  Record $a_i \midr [F(a_j) - \gamma, F(a_j))$.

  Combine $g_{\Sg'}$ for all the partitions to get a function 
  \begin{align*}
    g: \Sg \arr \It^I \times \Sub^J \times \Ct^{I \backslash J}.  
  \end{align*}
\end{Definition}

\begin{Lemma}
  Suppose we have $c, c' \in \Q_p^{|x|}$ such that $f(c), f(c')$ are in the same partition and $g(f(c)) = g(f(c'))$.
  Then $c, c'$ have the same $\Phi$-type over $B$.
\end{Lemma}

\begin{proof}
  Let $a_i = \vec p_i \cdot \vec c$ and $a_i' = \vec p_i \cdot \vec c'$ so that

  \begin{align*}
    f(c) &= (p_i(c))_{i \in I} = (\vec p_i \cdot \vec c)_{i \in I} = (a_i)_{i \in I} \\
    f(c') &= (p_i(c'))_{i \in I} = (\vec p_i \cdot \vec c')_{i \in I} = (a_i')_{i \in I}
  \end{align*}

  For each $i$ we show that $a_i, a_i'$ are in the same subinterval and have the same subinterval type, so the conclusion follows by Lemma \ref{main_lemma}
  ($f(c), f(c')$ are in the same partition ensuring the proper order of T-valuations for the 3rd condition of the lemma).
  $\It$ records the subinterval type of each element, so if $g(\bar a) = g(\bar a')$ then $a_i, a_i'$ have the same subinterval type for all $i \in I$.
  Thus it remains to show that $a_i, a_i'$ lie in the same subinterval for all $i \in I$.
  Suppose $i$ is an independent index.
  Then by construction, $\Sub$ records the subinterval for $a_i, a_i'$, so those have to belong to the same subinterval.
  Now suppose $i$ is dependent.
  Pick the largest $j < i$ such that $j$ is independent.
  We have $F(a_i) \leq F(a_j)$ and $F(a_i') \leq F(a_j')$.
  Moreover $F(a_j) = F(a_j')$ as $a_j, a_j'$ lie in the same subinterval (using the earlier part of the argument as $j$ is independent).
  
  \begin{Claim}
    $\val(a_i - a_i') > F(a_j) - \gamma$
  \end{Claim}
  \begin{proof}
    Let $K$ be the set of the independent indices less than $i$.
    Note that by the definition for dependent indices we have $\vec p_i \in \vecspan \curly{\vec p_k}_{k \in K}$.
    We also have 
    \begin{align*}
      \val(a_k - a_k') > F(a_k) \text { for all } k \in K
    \end{align*}
    as $a_k, a_k'$ lie in the same subinterval (using the earlier part of the argument as $k$ is independent).
    \begin{align*}
      &\val(a_k - a_k') > F(a_j) \text { for all } k \in K \text{ by monotonicity of $F(a_k)$} \\
      &\val(\vec p_k \cdot \vec c - \vec p_k \cdot \vec c') > F(a_j) \text { for all } k \in K \\
      &\val(\vec p_k \cdot (\vec c - \vec c')) > F(a_j) \text { for all } k \in K \\
    \end{align*}
    $K \subset I, i \in I, \vec c - \vec c' \in \Q_p^{|x|}, F(a_j) \in \Z$
    satisfy the requirements of Lemma \ref {gamma}, so we apply it to conclude
    \begin{align*}
      &\val(\vec p_i \cdot (\vec c - \vec c')) > F(a_j) - \gamma \\
      &\val(\vec p_i \cdot \vec c - \vec p_i \cdot \vec c') > F(a_j) - \gamma \\
      &\val(a_i - a_i') > F(a_j) - \gamma
    \end{align*}
    as needed, finishing the proof of the claim.
  \end{proof}	
  Additionally $a_i, a_i'$ have the same image in $\Ct$ component, so we have
  \begin{align*}
    \val(a_i - a_i') > F(a_j) 
  \end{align*}
  We now would like to show that $a_i, a_i'$ lie in the same subinterval.
  As $F(a_i) \leq F(a_j)$, $F(a_i') \leq F(a_j')$ and $F(a_j) = F(a_j')$ we have that
  $\val(a_i - a_i') > F(a_i)$ and $\val(a_i - a_i') > F(a_i')$
  Suppose that $a_i$ lies in the subinterval $\inti(t, F(a_i), \alpha_U)$
  and that $a_i'$ lies in the subinterval $\inti(t', F(a_i'), \alpha_U')$.
  Without loss of generality assume that $F(a_i) \leq F(a_i')$.
  As $\val(a_i - a_i') > F(a_i')$, this implies that
  \begin{align*}
    a_i &\in B(a_i', F(a_i')) \\
    a_i &\in B(t', F(a_i')) \\
    B(t, F(a_i)) &\cap B(t', F(a_i')) \neq \emptyset \\
    B(t, F(a_i)) &\subset B(t', F(a_i')) 
  \end{align*}
  For the subintervals to be disjoint we need 
  $\inti(t, F(a_i), \alpha_U) \cap B(t', F(a_i')) = \emptyset$.
  But $\val(t' - a_i) > F(a_i')$ implying that $a_i \in \inti(t, F(a_i), \alpha_U) \cap B(t', F(a_i'))$ giving a contradiction.
  Therefore the subintervals coicide finishing the proof.
\end{proof}

\begin{Corollary}
  $\Phi(x,y)$ has dual $\vc$-density $\leq |x|$.
\end{Corollary}

\begin{proof}
  Suppose we have $c, c' \in \Q_p^{|x|}$ such that $f(c), f(c')$ are in the same partition and $g(f(c)) = g(f(c'))$.
  Then by the previous lemma $c, c'$ have the same $\Phi$-type.
  Thus the number of possible $\Phi$-types is bounded by the size of the range of $g$ times the number of possible partitions
  
  \begin{align*}
    \text{(number of partitions)} \cdot |\It|^{|I|} \cdot |\Sub|^{|J|} \cdot |\Ct|^{|I-J|}
  \end{align*}

  There are at most $\paren{|2I|!}^2$ many partitions of $\Sg$,
  so in the product above, the only component dependent on $B$ is

  \begin{align*}
    |\Sub|^{|J|} \leq (N \cdot 3{|I|}^2)^{|J|} = O(N^{|J|})
  \end{align*}	
  
  Every $p_i$ is an element of a $|x|$-dimensional vector space, so there can be at most $|x|$ many independent vectors.
  Thus we have $|J| \leq |x|$ and the bound follows.
\end{proof}

\begin{Corollary} [Theorem \ref{main_theorem}]
  $(\Q_p, \LL_{aff})$ has $\vc(n) = n$.
\end{Corollary}

\begin{proof}
  Previous lemma implies that $\vc^*(\phi) \leq \vc^*(\Phi) \leq |x|$.
  As choice of $\phi$ was arbitrary, this implies that vc-density of any formula is bounded by the arity of $x$.
\end{proof}

This proof relies heavily on the linearity of functions $a_1, a_2, c$ in the cell deomposition result (see Definition \ref{cell}).
Linearity is used to separate $x$ and $y$ variables as well as
for Lemma \ref{gamma} to reduce the number of independent factors from $|I|$ to $|x|$.
The paper \cite{reduct} has cell decomposition results for more expressive reducts of $\Q_p$,
including, for exapmple, restricted multiplication.
While our results don't apply to it directly,
it is this author's hope that similar techniques can be used to compute $\vc(n)$ function for those structures.

\begin{thebibliography}{9}
\bibitem{density}
  M. Aschenbrenner, A. Dolich, D. Haskell, D. Macpherson, S. Starchenko,
  \textit{Vapnik-Chervonenkis density in some theories without the independence property}, I,
  Trans. Amer. Math. Soc. 368 (2016), 5889-5949
\bibitem{reduct}
  E. Leenknegt. \textit{Reducts of $p$-adically closed fields}, Archive for Mathematical logic, 53(3):285-306, 2014
\end{thebibliography}










\end{document}








